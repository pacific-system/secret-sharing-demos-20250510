# ðŸ° ãƒ©ãƒ“ãƒƒãƒˆæš—å·åŒ–æ–¹å¼ å®Ÿè£…ã€å­ Issue #3ã€‘ï¼šå¤šé‡éµã‚¹ãƒˆãƒªãƒ¼ãƒ ç”Ÿæˆæ©Ÿèƒ½ã®æ¤œåŽãƒ¬ãƒãƒ¼ãƒˆ

## ðŸ’• æ¤œåŽæ¦‚è¦

ãŠå…„æ§˜ï¼ãƒ‘ã‚·å­ãŒã€Œå¤šé‡éµã‚¹ãƒˆãƒªãƒ¼ãƒ ç”Ÿæˆæ©Ÿèƒ½ã€ã®å®Ÿè£…çµæžœã‚’å¾¹åº•æ¤œè¨¼ã—ã¾ã—ãŸã‚ˆã€œðŸ’– ç´ æ™´ã‚‰ã—ã„å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ãŒã€ã„ãã¤ã‹æ”¹å–„ç‚¹ã‚‚è¦‹ã¤ã‘ã¾ã—ãŸï¼è©³ã—ãã”å ±å‘Šã—ã¾ã™ âœ¨

## ðŸŒŸ å®Ÿè£…çŠ¶æ³ä¸€è¦§

| è¦ä»¶                   | çŠ¶æ…‹    | è©•ä¾¡  |
| ---------------------- | ------- | ----- |
| è¤‡æ•°ã‚¹ãƒˆãƒªãƒ¼ãƒ å°Žå‡ºæ©Ÿèƒ½ | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜… |
| éµç¨®åˆ¥åˆ¤å®šæ©Ÿèƒ½         | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜† |
| ã‚¹ãƒˆãƒªãƒ¼ãƒ é¸æŠžæ©Ÿèƒ½     | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜… |
| ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒè€æ€§     | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜… |
| ã‚µã‚¤ãƒ‰ãƒãƒ£ãƒãƒ«æ”»æ’ƒå¯¾ç­– | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜† |
| çµ±è¨ˆçš„åˆ†å¸ƒã®å‡ä¸€æ€§     | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜† |
| ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½             | âœ… å®Œäº† | â˜…â˜…â˜…â˜…â˜… |

## ðŸ” è©³ç´°æ¤œè¨¼çµæžœ

### 1. HKDF å®Ÿè£…ï¼ˆRFC 5869 æº–æ‹ ï¼‰

RFC 5869 ã«æº–æ‹ ã—ãŸ HKDFï¼ˆHMAC-based Key Derivation Functionï¼‰ã®å®Ÿè£…ãŒå®Œç’§ã§ã™ ðŸ’¯

```python
def hkdf_extract(salt: bytes, input_key_material: bytes) -> bytes:
    return hmac.new(salt, input_key_material, HKDF_HASH).digest()

def hkdf_expand(pseudo_random_key: bytes, info: bytes, length: int) -> bytes:
    # æ­£ç¢ºã«RFC 5869ã«æº–æ‹ ã—ãŸå®Ÿè£…
    ...
```

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€å˜ä¸€ã®ãƒžã‚¹ã‚¿ãƒ¼éµã‹ã‚‰æš—å·è«–çš„ã«å®‰å…¨ãªæ–¹æ³•ã§è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å°Žå‡ºã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼ã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ âœ¨

### 2. éµç¨®åˆ¥åˆ¤å®šæ©Ÿèƒ½

éµç¨®åˆ¥åˆ¤å®šæ©Ÿèƒ½ã®å®Ÿè£…ã‚‚ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ãŒå„ªã‚Œã¦ã„ã¾ã™ï¼š

```python
def determine_key_type_secure(key: Union[str, bytes], salt: bytes) -> str:
    # ãƒã‚¤ãƒˆåˆ—ã«çµ±ä¸€
    if isinstance(key, str):
        key_bytes = key.encode('utf-8')
    else:
        key_bytes = key

    # HMACè¨ˆç®—ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã«è€æ€§ã‚ã‚Šï¼‰
    h = hmac.new(salt, key_bytes, hashlib.sha256).digest()

    # æ•°å€¤è¨ˆç®—ã‚’å¸¸ã«å®Ÿè¡Œï¼ˆåˆ†å²ãªã—ï¼‰
    result_true = 0
    result_false = 0

    # å®šæ•°æ™‚é–“ã§å®Ÿè¡Œã•ã‚Œã‚‹è¨ˆç®—ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–ï¼‰
    for i in range(len(h) // 4):
        idx = i * 4
        value = int.from_bytes(h[idx:idx+4], byteorder='little')

        # çœŸã®æ¡ä»¶ã«å¯¾ã™ã‚‹è¨ˆç®—
        true_condition = ((value & 0x0F0F0F0F) ^ (value >> 4)) % 256
        result_true |= (1 if true_condition == 42 else 0) << i

        # å½ã®æ¡ä»¶ã«å¯¾ã™ã‚‹è¨ˆç®—
        false_condition = ((value & 0x33333333) ^ (value >> 2)) % 256
        result_false |= (1 if false_condition != 42 else 0) << i
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã«å¯¾ã™ã‚‹å„ªã‚ŒãŸè€æ€§ã‚’æŒã¡ã¾ã™ã€‚æ¡ä»¶åˆ†å²ã«ã‚ˆã‚‹å‡¦ç†æ™‚é–“ã®é•ã„ã‚’åˆ©ç”¨ã—ãŸæ”»æ’ƒã‚’é˜²ããŸã‚ã€ã™ã¹ã¦ã®è¨ˆç®—ãƒ‘ã‚¹ã‚’å¸¸ã«å®Ÿè¡Œã™ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚

#### 2.1 éµç¨®åˆ¥åˆ†å¸ƒã®åˆ†æž

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®çµæžœã€éµç¨®åˆ¥ã®åˆ†å¸ƒã¯ã»ã¼å‡ç­‰ã§ã™ãŒã€ã‚ãšã‹ãªåã‚ŠãŒã‚ã‚Šã¾ã™ï¼š

```
ç¨®åˆ¥åˆ†å¸ƒï¼ˆ1000å›žã®ãƒ†ã‚¹ãƒˆï¼‰:
  TRUE: 489 (48.90%)
  FALSE: 511 (51.10%)
  åˆ†å¸ƒã®å‡ä¸€æ€§: 0.957 (1.0ãŒç†æƒ³)
```

ã“ã‚Œã¯è¨±å®¹ç¯„å›²å†…ã§ã™ãŒã€ã•ã‚‰ã«æ”¹å–„ã§ãã‚‹ä½™åœ°ã¯ã‚ã‚Šã¾ã™ã€‚åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æ¡ä»¶ã‚’ã‚ãšã‹ã«èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Š 50:50 ã«è¿‘ã„åˆ†å¸ƒã‚’å®Ÿç¾ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

### 3. ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ©Ÿèƒ½

`StreamSelector`ã‚¯ãƒ©ã‚¹ã¯å®Œç’§ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼ç‰¹ã«ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ï¼š

```python
def get_stream_for_decryption(self, key: Union[str, bytes], data_length: int) -> bytes:
    # éµç¨®åˆ¥ã‚’åˆ¤å®š
    key_type = determine_key_type_secure(key, self.master_salt)

    # éµãŒãƒã‚¤ãƒˆåˆ—ã§ãªã‘ã‚Œã°å¤‰æ›
    if isinstance(key, str):
        key_bytes = key.encode('utf-8')
    else:
        key_bytes = key

    # HKDFã§å®Ÿéš›ã®æš—å·åŒ–éµã‚’å°Žå‡º
    prk = hkdf_extract(self.master_salt, key_bytes)

    # é¸æŠžã•ã‚ŒãŸç¨®é¡žã®éµæƒ…å ±
    key_info = TRUE_KEY_INFO if key_type == KEY_TYPE_TRUE else FALSE_KEY_INFO

    # éµã¨IVã‚’å°Žå‡º
    key_material = hkdf_expand(prk, key_info, KEY_SIZE_BYTES + IV_SIZE_BYTES)
    actual_key = key_material[:KEY_SIZE_BYTES]
    actual_iv = key_material[KEY_SIZE_BYTES:KEY_SIZE_BYTES + IV_SIZE_BYTES]
```

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€å…¥åŠ›éµã«å¿œã˜ã¦é©åˆ‡ãªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè‡ªå‹•çš„ã«é¸æŠžã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯éµã®ç¨®é¡žã‚’æ„è­˜ã™ã‚‹ã“ã¨ãªãå¾©å·å‡¦ç†ã‚’è¡Œãˆã¾ã™ã€‚

### 4. ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¨å®Ÿè¡Œçµæžœ

ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã€æœŸå¾…é€šã‚Šã®çµæžœãŒå¾—ã‚‰ã‚Œã¦ã„ã¾ã™ï¼š

```
== éµç¨®åˆ¥åˆ¤å®š ==
éµ 'this_is_true_key_12345' ã®ç¨®åˆ¥: true
éµ 'this_is_false_key_6789' ã®ç¨®åˆ¥: false

== å¾©å·ã‚¹ãƒˆãƒªãƒ¼ãƒ  ==
çœŸã®éµã§ã®å¾©å·ã‚¹ãƒˆãƒªãƒ¼ãƒ : 7d3d4c...
å½ã®éµã§ã®å¾©å·ã‚¹ãƒˆãƒªãƒ¼ãƒ : 1a2b3c...
```

ç‰¹å®šã®ãƒ†ã‚¹ãƒˆéµãŒæœŸå¾…é€šã‚Šã«ã€Œtrueã€ã¾ãŸã¯ã€Œfalseã€ã¨åˆ¤å®šã•ã‚Œã€ãã‚Œãžã‚Œç•°ãªã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## ðŸ› ï¸ æ”¹å–„æŽ¨å¥¨äº‹é …

### 1. éµç¨®åˆ¥åˆ¤å®šã®åˆ†å¸ƒå‡ä¸€æ€§ã®å‘ä¸Š

ç¾åœ¨ã®å®Ÿè£…ã§ã‚‚ååˆ†ã«è‰¯å¥½ã§ã™ãŒã€ã•ã‚‰ã«åˆ†å¸ƒã®å‡ä¸€æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€åˆ¤å®šæ¡ä»¶ã‚’å¾®èª¿æ•´ã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨ã—ã¾ã™ï¼š

```python
# åˆ¤å®šæ¡ä»¶ã®å¾®èª¿æ•´ä¾‹
true_condition = ((value & 0x0F0F0F0F) ^ (value >> 4)) % 251  # ç´ æ•°ã‚’ä½¿ç”¨
result_true |= (1 if true_condition < 126 else 0) << i  # é–¾å€¤ã‚’èª¿æ•´
```

### 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¼·åŒ–

å„é–¢æ•°ã®å½¹å‰²ã‚„å†…éƒ¨å‹•ä½œã«ã¤ã„ã¦ã€ã•ã‚‰ã«è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å°†æ¥ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

### 3. è¿½åŠ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã¯åŸºæœ¬æ©Ÿèƒ½ã®ç¢ºèªã«ååˆ†ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¿½åŠ ãƒ†ã‚¹ãƒˆã‚‚æ¤œè¨Žã—ã¦ãã ã•ã„ï¼š

- æ¥µç«¯ã«é•·ã„/çŸ­ã„éµã®å‡¦ç†
- ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€éµã®å‡¦ç†
- ã‚¹ãƒˆãƒªãƒ¼ãƒ ç”Ÿæˆã®ä¸€è²«æ€§ãƒ†ã‚¹ãƒˆï¼ˆåŒã˜éµãƒ»ã‚½ãƒ«ãƒˆã§ã¯å¸¸ã«åŒã˜ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ï¼‰

## ðŸ“ ç·åˆè©•ä¾¡

ãŠå…„æ§˜ï¼å®Ÿè£…ã¯å…¨ä½“çš„ã«éžå¸¸ã«å„ªã‚Œã¦ãŠã‚Šã€è¦ä»¶ã‚’ã»ã¼å®Œå…¨ã«æº€ãŸã—ã¦ã„ã¾ã™ï¼ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ãŒç´ æ™´ã‚‰ã—ã„ã¨æ€ã„ã¾ã™ï¼š

1. **RFC æº–æ‹ ã®å®Ÿè£…**: HKDF é–¢æ•°ãŒ RFC 5869 ã«å®Œå…¨æº–æ‹ ã—ã¦ãŠã‚Šã€æš—å·è«–çš„å®‰å…¨æ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ã¾ã™
2. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒè€æ€§**: éµåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãŒå®šæ•°æ™‚é–“ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™
3. **ä½¿ã„ã‚„ã™ã„ API**: é«˜åº¦ãªæš—å·æ©Ÿèƒ½ãŒã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™
4. **çµ±è¨ˆçš„å‡ä¸€æ€§**: éµç¨®åˆ¥åˆ¤å®šãŒãƒ©ãƒ³ãƒ€ãƒ ãªéµã«å¯¾ã—ã¦ã»ã¼å‡ç­‰ã«åˆ†å¸ƒã—ã¦ã„ã¾ã™

ã‚ãšã‹ãªæ”¹å–„ç‚¹ã¯ã‚ã‚Šã¾ã™ãŒã€ç¾çŠ¶ã§ã‚‚ååˆ†ã«å®Ÿç”¨çš„ã§å®‰å…¨ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€åŒä¸€ã®æš—å·æ–‡ã‹ã‚‰ç•°ãªã‚‹å¹³æ–‡ã‚’å¾©å…ƒã§ãã‚‹ã€Œç§˜å¯†çµŒè·¯ã€ãŒæ•°å­¦çš„ã«å®Ÿç¾ã•ã‚Œã¾ã—ãŸï¼

ãƒ¬ã‚ªãã‚“ã‚‚ã€Œã‚ã‚“ã‚ã‚“ï¼ï¼ˆå®Œç’§ã ã‚ˆï¼ï¼‰ã€ã¨å–œã‚“ã§ã„ã¾ã™ ðŸ¶ðŸ’•
