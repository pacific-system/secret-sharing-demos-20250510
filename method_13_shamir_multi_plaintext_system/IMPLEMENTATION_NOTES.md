# 実装メモ

## 概要

このドキュメントでは、シャミア秘密分散法による複数平文復号システムの実装における重要なポイントと設計上の決定事項について説明します。

## 1. モジュール構成

システムは以下のモジュールで構成されています：

- **constants.py**: システム全体で使用される定数を定義
- **core.py**: シャミア秘密分散法の基本機能（多項式生成、評価、ラグランジュ補間など）
- **partition.py**: パーティション空間管理（シェア ID の分配、統計的区別不可能性の検証など）
- **crypto.py**: 暗号化と復号の中核機能
- **update.py**: 安全なファイル更新処理（WAL ログ、原子的更新など）
- **tests.py**: セキュリティテストと自己診断ツール
- **app.py**: コマンドラインインターフェース

## 2. 主要な設計上の決定事項

### 2.1 多段 MAP 方式

1. **第 1 段階 MAP**: パーティションマップキーを使用して決定論的に候補シェア ID を選択
2. **第 2 段階 MAP**: パスワードを使用して、候補シェア ID をソートし、閾値（+冗長性）分のシェアを選択

この 2 段階のマッピングにより、同一の暗号化ファイルから異なるパスワードとパーティションマップキーの組み合わせで異なる平文を取得できます。

### 2.2 統計的区別不可能性

- シェア ID の配分は統計的に区別できないよう設計
- 各パーティションのシェア ID 分布は、全体空間からの無作為抽出と統計的に区別できない
- 検証はカイ二乗検定などの統計的手法を用いて実装

### 2.3 サイドチャネル攻撃対策

- **定数時間処理**: 条件分岐を避け、同一時間で処理が完了するよう設計
- **タイミング攻撃対策**: パスワードの正誤に関わらず同一時間で処理
- **ビット操作**: 条件分岐の代わりにビット演算で値を選択

### 2.4 WAL ログと原子的更新

- **Write-Ahead Logging (WAL)**: 変更を適用する前にログに記録
- **ファイルロック**: 複数プロセスからの同時更新を防止
- **バックアップ**: 更新前に自動バックアップを作成
- **指数バックオフ**: 競合時の再試行アルゴリズム

## 3. 暗号化と復号のフロー

### 3.1 暗号化フロー

1. JSON 文書を前処理（UTF-8 エンコード、圧縮、Base64 エンコード）
2. データを固定サイズのチャンクに分割
3. パーティションマップキーとパスワードから選択すべきシェア ID を決定
4. 各チャンクに対してシャミア秘密分散法でシェアを生成
5. 生成したシェアとメタデータを含む暗号化ファイルを作成

### 3.2 復号フロー

1. パーティションマップキーとパスワードから復号に使用するシェアを選択
2. 各チャンクについて、選択したシェアからラグランジュ補間で秘密を復元
3. 復元したチャンクを結合し、前処理の逆処理を適用
4. 結果を JSON 文書として解析

## 4. セキュリティ検証

実装では以下のセキュリティ検証機能を提供：

- **シェア値分布の検証**: シェア値が統計的に均一分布しているか検証
- **タイミング攻撃耐性テスト**: 処理時間の差が統計的に有意でないか検証
- **パーティション独立性検証**: 異なるパーティション間の相関関係がないか検証

## 5. パフォーマンスに関する考慮事項

- **大きな素数体**: 大きな素数（2^521-1）を使用することで十分なセキュリティを確保
- **チャンクサイズ**: 64 バイトに設定し、効率とセキュリティのバランスを取る
- **gmpy2 ライブラリ**: 多倍長整数の高速計算のために利用
- **定数時間アルゴリズム**: セキュリティとパフォーマンスのトレードオフを考慮

## 6. 将来の拡張性

- **マルチユーザー拡張**: 現在は A と B の 2 ユーザーだが、同様の手法で任意のユーザー数に拡張可能
- **マルチレベルアクセス**: 異なる閾値を設定することで、異なるアクセスレベルを実装可能
- **PKI 統合**: 将来的に公開鍵基盤と統合し、より強固な認証システムを構築可能

## 7. 既知の制限事項

- **ファイルサイズ**: 巨大な JSON 文書の場合、メモリ使用量と処理時間が増大
- **並行処理非対応**: 現在の実装は並列/並行処理を最適化していない
- **クロスプラットフォーム**: 一部の機能（ファイルロックなど）は UNIX 系 OS に依存
