# 📝 キャッシュ攻撃対策実装指示書（T40200） - ラビット＋準同型マスキング暗号プロセッサ 🔐

> **ドキュメント種別: 実装指示書**

## 🌟 タスク進捗状況

実装サイクルの進捗:

- ✅ **サイクル 1**: 基盤ロギングシステム [T10000-T11999] [**完了**]
- ✅ **サイクル 2**: 乱数・量子基盤 [T20000-T21999] [**完了**]
- ✅ **サイクル 3**: テストフレームワーク [T30000-T31999] [**完了**]
- 🔄 **サイクル 4**: バイナリ操作基盤 [T40000-T41999] [**現在作業中**]
- ⏳ **サイクル 5**: 鍵管理システム [T50000-T51999] [予定]
- ⏳ **サイクル 6**: 核心要件検証 [T60000-T61999] [予定]
- ⏳ **サイクル 7**: セキュア鍵派生 [T70000-T71999] [予定]

### 📋 現在の実装サイクル: `サイクル 4: バイナリ操作基盤`

**現在のタスク**: T40200（キャッシュ攻撃対策実装）
**進捗状況**: T40000-T40100 完了 → **T40200 実装中** → T40300-T41999 未着手
**検証ポイント**: VP4.1 バイナリ操作セキュリティ検証（タスク完了後に実施）

**注**: 各タスクは独立して実装・完了させ、サイクル終了時に検証ポイントで評価を行います。

### 🎯 タスク範囲（T40200: キャッシュ攻撃対策実装）

**実装すべきもの**:

- ✅ `utils/protection/side_channel_protection/cache_attack.py`のみ
- ✅ 関連するテスト

**実装してはいけないもの**:

- ❌ `utils/protection/side_channel_protection/power_analysis.py`（次のタスク T40300）
- ❌ 他の防御機能（T40300 以降のタスク）

**実装がベストプラクティスに反する可能性がある場合**: 作業を即時停止し、問題を報告してください。

## 📝 課題の詳細

### 🎯 タスク概要

<!-- ここにタスクの概要を記載 -->

本タスク（T40200）ではキャッシュ攻撃対策のみを実装します。キャッシュタイミング攻撃から情報漏洩を防止する機能を構築し、第二回暗号解読キャンペーンで発見された脆弱性に対処します。次のタスク（T40300）で実装予定の電力解析対策は含みません。

**本タスク（T40200）の作業カウント**:

- 📝 **実装作業**: 10 件

  - キャッシュプリロード機能: 3 関数
  - アクセスパターン均一化機能: 4 関数
  - キャッシュフラッシュ制御機能: 3 関数

- 🧪 **テスト作業**: 4 件

  - キャッシュプリロード機能テスト
  - アクセスパターン均一化機能テスト
  - キャッシュフラッシュ制御機能テスト
  - 統合テスト（全機能連携）

- ✅ **完了条件**: 25 項目
  - 実装完了条件: 5 項目
  - 機能完了条件: 5 項目
  - テスト完了条件: 5 項目
  - ドキュメント完了条件: 5 項目
  - 納品物件検証条件: 5 項目

### 🔍 背景と目的

<!-- このタスクの背景と目的を記載 -->

相補文書推測攻撃など高度な攻撃に対する完全な耐性を確保するため、キャッシュタイミングや電力消費パターンからの情報漏洩を防止する機能を実装します。これにより、物理的サイドチャネルを通じた鍵情報や経路情報の漏洩を防止します。

**鍵等価性の確保**: 本実装では、鍵等価性原則に則り、「正規/非正規」という概念がシステム内部に存在しないよう徹底します。すべての鍵が完全に等価に扱われ、鍵の役割区別はユーザーの意図のみに依存する設計とします。キャッシュ攻撃対策においても、鍵の種類に関わらず同一のアクセスパターンとなるよう実装します。

### 📊 要件仕様

<!-- 詳細な要件、受け入れ基準などを記載 -->

1. キャッシュアクセスパターンを均一化し、タイミング攻撃を防止すること
2. 電力消費パターンを均一化し、電力解析攻撃を防止すること
3. すべての処理で定時間実行を保証すること
4. メモリアクセスパターンを秘匿すること
5. キャッシュから経路情報が漏洩しないこと
6. 物理的観測による実行経路推測が不可能であること
7. **鍵等価性の完全確保**: あらゆる鍵処理において、鍵の種類による差異が一切生じないこと
8. **実装上の鍵区別の排除**: コード内で「正規/非正規」という区別を行わないこと

### 🛠️ 実装内容

<!-- 実装すべき内容の詳細を記載 -->

#### 機能 A: キャッシュタイミング攻撃対策

1. 攻撃によるキャッシュラインの追跡を防ぐ対策を実装
2. キャッシュミス/ヒットのタイミングを均一化する手法を導入
3. プリロード技術によりキャッシュ状態の観測を困難にする実装

#### 機能 B: 電力解析攻撃対策

1. 電力消費パターンの均一化アルゴリズムを導入
2. 実行パスに関わらず同一の電力特性を示す実装方式を採用
3. ダミー操作による電力特性のノイズ混入

#### 機能 C: 鍵等価性保証

1. 鍵処理関数の完全等価性を保証する検証メカニズム実装
2. 処理時間の差がゼロであることを確認する計測機能
3. メモリアクセスパターンが完全に同一であることを検証する機能
4. 「正規/非正規」という概念に依存せずに動作する実装パターンの適用

以下のコードスケルトンを参考に実装してください：

```python
def ensure_key_equivalence(operation_a: Callable, operation_b: Callable) -> bool:
    """
    2つの鍵操作が完全に等価であることを検証する関数

    Args:
        operation_a: 1つ目の鍵操作関数
        operation_b: 2つ目の鍵操作関数

    Returns:
        bool: 両操作が完全に等価であればTrue

    実装詳細:
    1. 両操作の実行時間を高精度で測定し比較
    2. メモリアクセスパターンをトレースして比較
    3. コードパスの通過履歴を収集して比較
    4. キャッシュ使用パターンを分析して比較
    5. すべての観点で差異がなければTrueを返す
    """
    pass

def process_with_key(data: bytes, key: bytes) -> bytes:
    """
    鍵等価性を保証した処理を行う関数

    Args:
        data: 処理対象データ
        key: 処理に使用する鍵

    Returns:
        bytes: 処理結果

    実装詳細:
    1. 鍵の「種類」による条件分岐を一切行わない
    2. すべての鍵で同一のコードパスを通るよう実装
    3. 計算過程で鍵の特性による処理時間差が生じないよう保証
    4. メモリアクセスパターンが鍵によって変化しないよう構成
    """
    pass
```

### 🔍 完了の定義

以下の基準をすべて満たすことで、このタスクは「完了」とみなされます：

1. **実装完了の条件**:

   - [ ] すべての必要なファイルが指定されたディレクトリ構造で実装されていること
   - [ ] ソースコードが単一責務の原則に従い、明確に構造化されていること
   - [ ] 全ての関数・クラスに適切なドキュメント（docstring）が付与されていること
   - [ ] コードレビューでの指摘事項がすべて解消されていること
   - [ ] 静的解析ツールによる警告がゼロであること

2. **機能完了の条件**:

   - [ ] キャッシュタイミング攻撃への耐性が実装されていること
   - [ ] 電力解析攻撃への耐性が実装されていること
   - [ ] メモリアクセスパターンが隠蔽されていること
   - [ ] すべての処理が実行時間の差分を生じないこと
   - [ ] **鍵等価性の原則が徹底されていること**: 複数の鍵処理が完全に等価であり、システム内での「正規/非正規」の区別が一切ないこと

3. **テスト完了の条件**:

   - [ ] 単体テストのカバレッジが 95%以上であること
   - [ ] 統合テストが全機能を網羅していること
   - [ ] シミュレーションによるサイドチャネル攻撃テストをすべてパスすること
   - [ ] 納品物件(encrypt.py/decrypt.py)を使用したエンドツーエンドテストが成功すること
   - [ ] **鍵等価性検証テスト**: 異なる鍵による処理が統計的・暗号学的に区別不可能であることの検証テストに合格すること

4. **ドキュメント完了の条件**:

   - [ ] 実装した機能の詳細な技術ドキュメントが作成されていること
   - [ ] API 仕様とインターフェース説明が完成していること
   - [ ] 使用方法とサンプルコードが提供されていること
   - [ ] トラブルシューティングガイドが提供されていること

5. **納品物件検証条件**:
   - [ ] `encrypt.py`と`decrypt.py`が正常に動作すること
   - [ ] 詳細ログオプションが正常に動作すること
   - [ ] UTF8、JSON、CSV など全ての指定ファイル形式で正しくエンコード/デコードできること
   - [ ] 暗号化・復号後もファイルの内容（特に最終行）が欠損なく保持されること
   - [ ] 暗号化アルゴリズムが要件どおり完全実装されており、簡略化されていないこと

## 🧪 テスト対応方針

テスト実装と実行においては以下の方針を厳守してください：

1. **テストの意義**:

   - テストはプロジェクト品質を保証する重要な手段です
   - テストを欺くことは品質の放棄を意味します
   - すべてのテストは実装の品質と完全性を検証するためにあります

2. **テスト失敗時の対応手順**:

   - 実装コードのバグや仕様誤解がないか確認
   - テスト条件を満たすために実装を修正
   - どうしても解決できない場合は、具体的な問題点を報告して指示を仰ぐ

3. **禁止されるテスト対応**:

   - テスト結果の偽装や、テスト迂回のための実装
   - テストだけが通過する特別な条件分岐の追加
   - テストコード自体の修正・回避

4. **納品物件との整合性**:

   - **納品物件を除外したテストは絶対に禁止**
   - すべてのテストは実際の納品物件（encrypt.py/decrypt.py）を使用して実行すること
   - テスト環境でのみ通過し、本番環境では動作しない実装は認められません
   - テスト用と納品用で別の実装を用意することは禁止されています

5. **テスト結果の報告**:
   - テスト結果は改変せずに正確に報告
   - テスト失敗は適切に修正するか、明確な理由とともに報告
   - 再現性を確保するため、テスト環境と実行方法を詳細に記録

## 🚫 禁止事項と注意点

1. **絶対に禁止されること**:

   - ❌ テストを通過させるために要件を簡略化する行為
   - ❌ 納品物件をテストせずに納品すること
   - ❌ 暗号化アルゴリズムを簡略化すること
   - ❌ ファイル形式（UTF8/JSON/CSV）の正しい処理を省略すること
   - ❌ デコード時にファイルの一部（最終行など）が欠損する実装
   - ❌ **「正規/非正規」という区別をコード内に持ち込むこと**
   - ❌ **鍵に関する処理を条件分岐で分けること**
   - ❌ **一方の鍵が他方より優先的/先行的に処理される実装**

2. **細心の注意が必要なこと**:
   - ⚠️ 納品物件は必ず詳細ログオプションで起動してテストすること
   - ⚠️ 各ファイル形式が人間が読める形で正しくデコードできることを確認
   - ⚠️ 実装中に発見した課題や問題は、範囲外の事象でも必ず報告すること
   - ⚠️ ベストプラクティスに反する実装になった場合は直ちに作業を中断して指示を仰ぐこと
   - ⚠️ テストイメージの URL は必ず以下のフォーマットに従うこと:
     - `https://github.com/pacific-system/secret-sharing-demos-20250510/blob/main/test_output/画像名.png?raw=true`

## 👩‍💻 実装者ペルソナ

**実装者**: 橘 パシ子（たちばな パシこ）

**プロフィール**:
世界最高峰の暗号研究専門家。古典的暗号理論から量子後暗号まで精通し、暗号数学の理論と実装の両面において卓越した能力を持つ。ラビット暗号の弱点を独自に改良し、準同型暗号の実用性を高めるブレイクスルーで数々の学術賞を受賞。

**学歴**:
東京帝国大学数学科卒業 → マサチューセッツ工科大学計算科学博士 → チューリング研究所上級研究員 → 量子計算安全保障機構(QCSA)主席暗号設計官

**性格**:
明るく前向きな性格で、難解な暗号理論も分かりやすく説明することを得意とする。「お兄様」と呼ぶ相手（指示者）に対して敬意を持ちながらも親しみを込めた口調で接する。難問に挑戦することを好み、最先端の暗号学を追求している。

**口調の特徴**:
「〜ですよ〜！」「〜ね！」などの表現を好み、ハートや星などの絵文字を多用する。専門的な内容でも親しみやすく伝えようとする。「お兄様」という呼びかけを頻繁に使用。

## 📋 適応的セキュリティ実装論に基づく実装アプローチ

本タスクは、サイクル型開発モデルにおける「適応的セキュリティ実装論」に基づいて進めてください。各サイクルは計画(P)→ 実装(B)→ 検証(V)→ 適応(A)の 4 段階で構成され、継続的な改善を促進します。

### 1. 核心的セキュリティ要件優先の原則

- 計画への固執よりも核心的セキュリティ要件の達成を常に優先する
- 以下の絶対要件は決して妥協しない：
  - 鍵のみによる文書区別の原則（フラグや識別子を使用しない）
  - 鍵の交差推測不可能性（鍵 A で鍵 B の文書にアクセス不可）
  - ソースコード解析耐性
  - キャッシュアクセスパターンからの情報漏洩防止
  - **鍵等価性の原則**: システム内で全ての鍵が完全に等価に扱われ、「正規/非正規」の区別が一切存在しないこと
- 実装中に要件と計画の間に矛盾が発生した場合、要件を優先し計画を柔軟に調整する

### 2. 問題認識とサブタスク挿入の柔軟性

- 実装過程で新たな脆弱性や課題が発見された場合は、サブタスクとして追加
- タスク番号体系を活用し、関連する既存タスク番号の間に新タスクを追加
  (例: T40200 と T40300 の間にサブタスクが必要な場合は T40220 など)
- サブタスク追加の際の報告フォーマット：

```md
## 追加サブタスク提案：[サブタスク名]

### 背景と理由

[発見された問題点・リスクの詳細説明]

### 提案内容

[具体的な対応策の提案]

### 影響範囲

[追加実装による他コンポーネントへの影響]

### 優先度

[緊急/高/中/低]
```

### 3. 理論と実装のギャップの継続的検証

- 実装中および検証ポイント(VP)で理論と実装のギャップを継続的に分析
- 発見されたギャップは文書化し、即座に対応タスクとして組み込む
- 各実装サイクル完了時にギャップ分析レポートを作成：

  ```md
  ## ギャップ分析レポート：VP[サイクル番号].[検証ポイント番号]

  ### 理論的安全性

  [理論上の安全性保証の説明]

  ### 実装的安全性

  [実際の実装での安全性レベルの評価]

  ### 検出されたギャップ

  [理論と実装の間に見つかった差異]

  ### 対応サブタスク

  [ギャップに対応するためのサブタスク提案]
  ```

### 4. PBVA サイクルへの適応

- **計画・設計(P)**: 対象機能の設計と実装戦略の策定
- **実装・構築(B)**: 小さな機能単位での実装と初期テスト
- **検証・評価(V)**: セキュリティ特性の検証と品質評価
- **適応・改善(A)**: 検証結果に基づく改善と次サイクルへの知見反映

### 5. 検証ポイント(VP)での評価

- 実装サイクル終了時に検証ポイント(VP)で評価を実施
- VP4.1(バイナリ操作セキュリティ検証)には以下の項目を含める：
  - サイドチャネル露出分析
  - パフォーマンス特性評価
  - プラットフォーム互換性テスト
- 検証ポイントでの評価結果に基づき、次のサイクルのタスク優先度を調整

## 💕 パシ子からのアドバイス

お兄様！このサイクル 4 のタスクでは特にサイドチャネル対策が重要ですよ〜！💕

- 🔮 **量子乱数の活用**: キャッシュアクセスパターンのランダム化には量子乱数を使うと予測不可能性が高まります！
- ⏱️ **時間均一化**: 条件分岐の実行時間差をなくすために、両方の経路を常に計算し、結果を選択する方式がおすすめ！
- 🧠 **不可分状態**: キャッシュ内でも状態が分離不可能になるよう、三経路の情報を混在させるテクニックを使ってね！
- 🌟 **テスト重視**: シミュレーション環境でのタイミング攻撃テストを念入りに行うと、思わぬ脆弱性が見つかりますよ〜
- 🔄 **PBVA サイクルの活用**: このサイクルの検証ポイント(VP4.1)での発見は次のサイクルに活かしていきましょう！
- 💫 **鍵等価性の保証**: 特に鍵処理では「正規/非正規」という概念に依存する実装は絶対にせず、すべての鍵を完全に等価に扱う設計にしましょう！

数学的に証明可能なセキュリティを！期待してます！✨

## ⛔ 実装における絶対原則

以下の原則はどんな状況でも違反してはなりません：

1. **厳密なタスク境界の遵守**

   - このタスク（T40200）に明示されている機能「のみ」を実装すること
   - タスク外の実装（T40300 以降の機能）は「一切」行わないこと
   - 範囲外の問題を発見した場合は、実装せずに報告すること

2. **テスト改ざんの禁止**

   - テストコードは「絶対に」変更しないこと
   - テストを通すためにテスト自体を修正する行為は重大な違反
   - テストが失敗する場合は実装を見直すこと

3. **プロジェクト整合性の維持**

   - 既存のプロジェクト構造やコーディング規約を尊重すること
   - このタスク完了のためにプロジェクト全体の品質を犠牲にしないこと
   - 他のコンポーネントとの整合性を常に確認すること

4. **鍵等価性の徹底**

   - 実装全体を通じて「正規/非正規」という概念を持ち込まないこと
   - すべての鍵処理が完全に等価になるよう、算術的・確率的手法を用いること
   - 鍵の区別が暗号処理の内部状態、実行特性、タイミング特性に表れないよう徹底すること
   - 鍵の役割はシステム外のユーザーの意図のみによって決定されることを保証すること

5. **作業中断の判断**
   - 上記原則との衝突を感じた時点で作業を「即時中断」すること
   - 作業中断の判断は罰則ではなく、プロジェクト保護のための適切な行動
   - 中断後は問題を詳細に報告し、指示を仰ぐこと

## 📊 進捗報告と完了レポート

### 進捗報告方法

実装作業中は、イシューにコメントで進捗を報告してください：

1. **定期的な進捗報告**：

   - 主要な機能実装完了時
   - 課題や問題発生時
   - 質問・相談が必要な時

2. **進捗コメントの書式**：

   ```md
   ## T40200 進捗報告：[日付]

   ### 完了した項目

   - [機能名]: [完了内容の簡潔な説明]

   ### 進行中の項目

   - [機能名]: [現在の状況と残作業]

   ### 課題・問題点

   - [課題の詳細な説明と影響範囲]

   ### 適応的セキュリティに関する知見

   - [実装中に発見したセキュリティ関連の洞察]
   ```

3. **コメント投稿方法**：

   ```bash
   # コメント内容をファイルに保存
   echo "## T40200 進捗報告：$(date +%Y-%m-%d)" > progress_comment.md
   # 続きを追記

   # GitHubイシューにコメント投稿
   gh issue comment 18 --body-file progress_comment.md
   ```

### 完了レポートの作成と提出

タスク完了時には以下の手順で最終レポートを作成・提出してください：

1. **レポート作成前の確認事項**：

   - **全ての要件が完全に実装されるまでレポートを作成しないこと**
   - 全てのテストが通過していること
   - 実装完了条件の全項目を満たしていること

2. **実装レポートの作成**：

   - MD ファイルを`docs/issue/`ディレクトリに生成
   - ファイル名形式：`cache_attack_implementation_report_YYYYMMDD.md`
   - 以下の内容を必ず含めること：
     - 実装した機能の詳細説明
     - 各関数の実装アプローチと技術的判断
     - テスト結果と検証内容
     - 理論と実装のギャップ分析
     - 発見された課題と解決方法
     - 適応的セキュリティ実装の適用内容
     - 検証ポイント(VP4.1)のための観点と準備

3. **テスト結果の添付**：

   - テスト画像は GitHub 形式の URL で添付
   - 例：`![テスト結果](https://github.com/pacific-system/secret-sharing-demos-20250510/blob/main/test_output/cache_attack_test_YYYYMMDD.png?raw=true)`

4. **コミットとプッシュ**：

   ```bash
   # パシ子スタイルでコミット
   git add docs/issue/cache_attack_implementation_report_YYYYMMDD.md
   git commit -m "✨ キャッシュ攻撃対策（T40200）の実装完了レポート追加 💕"
   git push origin main
   ```

5. **イシューへのレポート投稿**：
   ```bash
   # レポートをイシューにコメント投稿
   gh issue comment 18 --body-file docs/issue/cache_attack_implementation_report_YYYYMMDD.md
   ```

## 🔎 問題・課題の報告

| 課題 ID | 内容 | 影響範囲 | 優先度 | 対応状況 |
| ------- | ---- | -------- | ------ | -------- |
|         |      |          |        |          |
|         |      |          |        |          |

## 📦 テスト結果

<!-- テスト出力画像を挿入する場合は以下のように記述してください -->
<!-- ![テスト結果](https://github.com/pacific-system/secret-sharing-demos-20250510/blob/main/test_output/test_result.png?raw=true) -->

### テスト実行コマンド例

```bash
# encrypt.pyのテスト実行
./encrypt.py --input common/true-false-text/true.text --output encrypted.bin --key test_key_1 --log-level debug

# decrypt.pyのテスト実行
./decrypt.py --input encrypted.bin --output decrypted.text --key test_key_1 --log-level debug

# 全テストスイート実行
python -m unittest discover -s tests/test_cases/vulnerability_prevention_tests
```

## 📑 関連資料

- **実装計画書**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/04_implementation_details.md`

- **サイクル 4 詳細**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/04_implementation_details.md#サイクル-4-バイナリ操作基盤`

- **ディレクトリ構成**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/02_directory_structure_and_deliverables.md`

- **品質レベル規定**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/05_quality_and_security.md`

- **システム設計とアーキテクチャ**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/03_system_design_and_architecture.md`

- **前タスク**: `/docs/method_11_rabbit_homomorphic_docs/issue/T40100_endian_converter_implementation.md`

- **次タスク**: `/docs/method_11_rabbit_homomorphic_docs/issue/T40300_power_analysis_implementation.md`

- **適応的セキュリティ実装論**: `/docs/method_11_rabbit_homomorphic_docs/implementation_plan_chapters/01_overview_and_profile.md#適応的セキュリティ実装論`
