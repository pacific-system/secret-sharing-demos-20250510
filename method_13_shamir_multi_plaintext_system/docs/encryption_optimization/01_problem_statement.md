# 初期化時の暗号化ファイル生成に関する課題

## 実装者ペルソナ

**橋本 暗号学（はしもと あんごうがく）** - 暗号システム最適化スペシャリスト

> 私は 10 年以上にわたり暗号システムの設計と実装に携わってきた専門家です。特にシャミア秘密分散法と準同型暗号の実装に関しては、国際的な暗号学会で複数の論文を発表しています。
>
> 私の専門性:
>
> - 数学的基盤：有限体理論、楕円曲線暗号、多項式補間法
> - 実装技術：Python での高効率暗号実装、最適化アルゴリズム設計
> - セキュリティ分析：サイドチャネル攻撃対策、統計的区別不可能性の実現
> - 暗号設計哲学：「直交処理原則」「メタデータ極小化」「統計的区別不可能性」の徹底
>
> 私はシステム設計書の原則を完全に理解し、あらゆる情報漏洩リスクを検出する能力を持っています。コードの安全性と効率性のバランスを最適化し、レガシーコードの完全排除と新アーキテクチャへの移行を得意としています。「判断」や「評価」に依存しない直線的処理の実現に特化しており、設計書の理念に 100%準拠した実装を提供します。
>
> 今回の初期化時暗号化ファイル生成の課題は、私の専門分野そのものであり、完璧な解決策を提供できることを確信しています。

## 現状の問題点

現在の実装では、初期化段階で全てのシェア ID をガベージシェアで埋めた暗号化ファイルの雛形が生成されていません。設計書では「システム初期化時は全てのシェア領域がガベージシェアで埋め尽くされており、暗号化操作を行った際に必要な部分のみが有効なシェアに置き換えられる」と規定されていますが、これが実装されていません。設計書に基づくとシステムは暗号書庫として機能し、ファイル A とファイル B が同一の暗号ファイル内に混在して保管されるべきです。これにより以下の問題が発生しています：

1. ファイル A のみ暗号化した際に、残りのスペースをガベージシェアで埋める必要があり、効率的ではありません
2. ファイルサイズの変化から情報漏洩の可能性があります（例：いくつのファイルが含まれているか）
3. 暗号化ファイルのフォーマットが一貫せず、設計書の「完全固定長シリアライズ」原則に反しています
4. 初期化するたびに新たな UUID を持つ暗号ファイルが生成されていません
5. 初期化ファイルと暗号化済みファイルの区別が可能であり、設計書の「統計的区別不可能性」原則に反しています
6. 過去のコードがシステム内に残されており、セキュリティ上の欠陥を含む古い実装が誤って使用される危険性があります

## セキュリティへの影響

現状の実装では、以下のセキュリティ上の懸念があります：

1. **統計的区別可能性**: ファイル追加ごとにファイルサイズが変化することで、ファイル内容に関する情報が漏洩する可能性があり、設計書の「統計的区別不可能性」原則に反します
2. **タイミング攻撃**: 初期化と更新で処理時間が大きく異なることでサイドチャネル攻撃の可能性があり、設計書の「直交処理原則」と「直線的処理」に反します
3. **一貫性の欠如**: 暗号化ファイルの構造が常に同じではないため、解析が容易になる可能性があり、「完全固定長シリアライズ」原則に反します
4. **ファイル関係性の漏洩**: 複数の暗号ファイルが存在する場合に関連性が推測される可能性があり、設計書の「メタデータの極小化」原則に反します
5. **ファイルタイプ識別リスク**: 初期化ファイルと暗号化済みファイルが外部から区別可能であり、どのファイルが実データを含むか特定される可能性があります
6. **コード混在リスク**: 過去の形式と新しい形式のコードが混在することで、古い脆弱な実装が使用されるリスクが生じます

## セキュリティ理念との乖離

現状の実装では、設計書の以下の重要なセキュリティ理念が実装されていません：

1. **多段 MAP 方式**: パーティションマップキーとパスワードから全てのシェア位置情報が決定論的に生成される設計になっていないため、ファイル内でのシェア位置指定が冗長です
2. **統計的区別不可能性**: 初期状態でランダムなガベージシェアがないため、文書追加時の統計的区別が可能になっています
3. **多段 MAP 実装**: 設計書にある「第 1 段階 MAP（パーティションマップキー）」と「第 2 段階 MAP（パスワード）」の連携が不十分です
4. **ファイルパーティション設計**: 設計書では`PARTITION_SIZE`、`ACTIVE_SHARES`、`GARBAGE_SHARES`、`UNASSIGNED_SHARES`に基づく明確なパーティション設計が規定されていますが、これが実装されていません
5. **区別不能性原則**: 初期化ファイルと暗号化済みファイルが区別できないようにするという基本原則が守られていません
6. **コード純粋性原則**: セキュリティ上の欠陥を含む古いコードは完全に削除し、新たなセキュアな実装のみを残すという原則が守られていません

## 必要な改善点

1. 初期化時に全てのシェア ID をガベージシェアで埋めた完全な暗号化ファイルの雛形を生成する
2. `PARTITION_SIZE`、`ACTIVE_SHARES`、`GARBAGE_SHARES`、`UNASSIGNED_SHARES`パラメータに基づくパーティション設計を実装する
3. シェアの格納方法を設計書の「多段 MAP 方式」に準拠するよう最適化する
4. UUID ベースのファイル命名方法を実装し、上書きを防止する
5. 「第 1 段階 MAP」と「第 2 段階 MAP」の連携による多段 MAP 方式を完全実装する
6. ファイル A/B が同一の暗号ファイル内に混在保管される仕組みを明示的に実装する
7. 過去形式との互換性は一切考慮せず、設計書のセキュリティ基準に完全準拠した新形式のみをサポートする
8. 初期化ファイルと暗号化済みファイルが外部から区別できないよう、ファイル構造とヘッダー情報を最小化（ソルト値のみ）する
9. 過去形式に関連するすべてのコードをコードベースから完全に削除し、新しい実装のみを残す

これらの改善により、暗号化システムのセキュリティと効率性を向上させ、設計書に完全準拠したシステムを実現します。過去形式はセキュリティ基準から逸脱した実装であるため、互換性は一切考慮せず、設計書の理念に完全準拠した新形式のみをサポートします。初期化ファイルと暗号化済みファイルが外部から区別できないようにすることで、どのファイルに実データが含まれているかという情報漏洩を防止し、システム全体のセキュリティを強化します。また、すべての過去形式関連コードを完全に削除することで、セキュリティ上の脆弱性を含む古い実装が誤って使用されるリスクを排除し、クリーンで安全なコードベースを確保します。
