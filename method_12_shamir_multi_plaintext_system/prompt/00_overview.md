# シャミア秘密分散法による複数平文復号システム - 実装プロンプト

## システム概要と目的

あなたは暗号学とセキュアコーディングに精通した開発者です。シャミア秘密分散法を応用した「複数平文復号システム」を実装してください。このシステムは単一の暗号化ファイルから異なるパスワードを使用して異なる平文（JSON 文書）を復号可能にするものです。

**核心技術**: 「シェア ID による可能性の限定とパスワードによるマップ生成」という多段 MAP 方式

**重要な原則**: このシステムはケルクホフの原理に厳格に従います。アルゴリズムが完全に公開されてもパスワード（鍵）が秘匿されている限りセキュリティが保たれるよう設計してください。

## システムアーキテクチャ

### 基本原理

1. **シャミア秘密分散法**: 閾値暗号の一種。秘密情報を複数のシェアに分散し、一定数以上のシェアで元の情報を復元
2. **多段 MAP 方式**: シェア ID による第 1 段階の絞り込みとパスワードによる第 2 段階のマッピング
3. **統計的区別不可能性**: 異なる文書のシェアや未割当領域のシェアが統計的に区別できない
4. **直線的処理**: 復号処理中に評価や条件分岐を一切含まない

### 多段 MAP 方式の詳細

1. **第 1 段階（シェア ID による限定）**:

   - ユーザーが保持するシェア ID セットにより、全シェア空間から復号候補となるシェアの範囲を限定
   - この段階で不要なシェアの大部分を除外

2. **第 2 段階（パスワードによるマッピング）**:
   - パスワードから鍵導出関数を用いてマップデータを生成
   - 第 1 段階で限定された範囲内のシェアだけを対象にマッピングを適用
   - マッピング結果に基づき、実際に復号に使用するシェアを特定

## 実装上の絶対条件

### 1. セキュリティモデルの厳守

- **条件分岐の禁止**: 復号処理中に条件分岐を含めないこと（タイミング攻撃対策）
- **定数時間処理**: 全ての操作が入力値に関係なく一定時間で処理されること
- **統計的区別不可能性**: シェアの種類（A/B/未割当）が統計的に区別できないこと

### 2. シェア ID 空間設計

- **分割比率**: A 用 30-40%、B 用 30-40%、未割当 20-40%
- **分散配置**: 連続範囲や単純パターンを避け、バラバラに配置
- **実装方法**: 擬似乱数生成器で初期化、割り当て判別には 4 要素（パスワード A、B、シェア ID セット A、B）が全て必要

### 3. データ構造設計原則

- **最小情報の原則**: 復号に必須の情報のみを保存
- **識別情報の排除**: 文書種別の識別子（A/B 等）を含めない
- **構造的匿名性**: データ構造自体から情報が漏洩しないよう設計
- **冗長性の最小化**: 同じ情報を複数箇所に保存しない

### 4. 禁止事項

- ベストプラクティスに反する実装
- バックドアの設置や復号偽装
- 大原則（統計的区別不可能性、直線的処理等）を回避する設計

## 全体構成と依存関係

実装は次の 3 つの主要コンポーネントに分割されます:

1. **暗号化モジュール**: 複数の JSON 文書を単一の暗号化ファイルにエンコード
2. **復号化モジュール**: シェア ID とパスワードを用いて暗号化ファイルから特定の JSON 文書を復元
3. **更新モジュール**: 既存の暗号化ファイルの特定文書部分のみを安全に更新

これらのモジュールは CLI インターフェースから呼び出されます。
それぞれのモジュールの詳細実装は各ファイルを参照してください。

## 実装言語とライブラリ

- 実装言語: **Python**
- 推奨暗号ライブラリ:
  - KDF: `hashlib.pbkdf2_hmac` または `argon2-cffi`
  - 乱数生成: `secrets`モジュール
  - 有限体演算: `gmpy2`（必要な場合）
