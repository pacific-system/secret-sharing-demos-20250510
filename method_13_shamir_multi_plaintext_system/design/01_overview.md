# シャミア秘密分散法による複数平文復号システム設計書

## 1. 概要

本設計書では、シャミア秘密分散法を応用した「複数平文復号システム」の詳細設計を提供する。このシステムは単一の暗号化ファイルから異なるパスワードを使用して異なる平文（JSON 文書）を復号可能にするもので、「パーティションマップキーによる MAP 生成とパスワードによるマップ生成」という多段 MAP 方式を核心とする。本システムでは、シャミア秘密分散法の従来の閾値概念を使用せず、常に全てのシェアを使用して確実な復号を行うアプローチを採用している。

本システムは明確に分離された 3 つのシンプルな責務を持つ：

- **暗号書庫生成（createCryptoStorage）**：初期状態の暗号書庫を作成し、A/B 両領域の基盤構造を確立する
- **暗号書庫更新（updateCryptoStorage）**：指定されたパーティションマップキーとパスワードに対応する領域にデータを格納する
- **暗号書庫読取（readCryptoStorage）**：指定されたパーティションマップキーとパスワードを使用して特定の平文を復号する

本システムの設計は以下の重要な特徴を持つ：

1. **全シェア使用方式**：部分的なシェアからの秘密情報漏洩のリスクを排除し、シェア選択攻撃に対する堅牢性を高める

2. **多段 MAP 方式**：パーティションマップキーとパスワードによる 2 段階のマッピングにより、単一ファイル内での複数平文の分離を実現

3. **固定サイズチャンク**：全てのデータを 64 バイト固定サイズのチャンクで処理し、統計的区別不能性を確保

4. **容量検証と完全パディング**：暗号化前にデータ容量を固定容量化し、第 2 段階 MAP で確定した全シェア位置に有効データを配置

5. **直交処理原則の厳格な適用**：入力データの特性に左右されず常に同一の処理を実行することで、サイドチャネル攻撃への耐性を強化

6. **メタデータの極小化**：ソルト値のみを保存し、バージョン情報を含む他のメタデータを完全に排除

7. **Unicode 完全対応パスワード**：UTF-8 マッピングのあらゆる文字（漢字・絵文字等）をサポートし、パスワード処理によって一貫した処理を実現

   - パーティションマップキーの暗号化には**全文そのままのパスワード（生のパスワード）**を使用
   - 第 2 段階 MAP の生成には**必ず処理（ハッシュ化）されたパスワード**を使用（開発者は生のパスワードを誤って使用してはならない）

8. **整数値による明示的なパーティション設計**：`ACTIVE_SHARES`、`GARBAGE_SHARES`などを整数値で明示的に定義し、`PARTITION_SIZE`と`SHARE_ID_SPACE`を自動計算することで、確定的かつ安定したパーティション空間を実現

9. **固定容量の明確化**：各ファイルが使用可能な最大データ容量を`ACTIVE_SHARES × CHUNK_SIZE`で明示的に定義し、容量計画の透明性を確保

10. **ファイル間の完全対称性**：ファイル A/B それぞれに同一サイズのパーティションを割り当て、完全な対称性を実現することでセキュリティを強化

11. **障害耐性と自動復旧機能**：更新処理中の障害に対応するためのバックアップ・復元メカニズムを実装し、処理中断時の自動復旧を可能にする。ロックファイルによる処理状態追跡と設定期間に基づくバックアップ管理により、データの整合性と保全性を確保

12. **完全固定長シリアライズ**: Base64 エンコード後のデータをパーティションマップキーを使って固定長形式に暗号化することで、データ内容の統計的特徴を完全に隠蔽

これらの特徴により、システムは高い安全性と堅牢性を実現し、A/B の異なる平文を単一の暗号化ファイルから安全に取り出すことが可能となる。

本システムの設計はケルクホフの原理に厳格に従い、システムのセキュリティがアルゴリズムの秘匿ではなくキー（パスワード）の秘匿のみに依存するよう設計されている。
