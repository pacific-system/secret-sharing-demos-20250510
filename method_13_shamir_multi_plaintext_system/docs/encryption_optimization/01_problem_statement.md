# 初期化時の暗号化ファイル生成に関する課題

## 現状の問題点

現在の実装では、初期化段階でゴミデータで埋められた暗号化ファイルの雛形が生成されていません。システムは暗号書庫として機能し、ファイル A とファイル B が同一の暗号ファイル内に混在して保管されます。これにより以下の問題が発生しています：

1. ファイル A のみ暗号化した際に、残りのスペースをゴミデータで埋める必要があり、効率的ではありません
2. ファイルサイズの変化から情報漏洩の可能性があります（例：いくつのファイルが含まれているか）
3. 暗号化ファイルのフォーマットが一貫していません
4. 初期化するたびに新たな UUID を持つ暗号ファイルが生成される必要があります
5. 初期化ファイルと暗号化済みファイルの区別が可能であり、セキュリティリスクが生じています
6. 過去のコードがシステム内に残されており、セキュリティ上の欠陥を含む古い実装が誤って使用される危険性があります

## セキュリティへの影響

現状の実装では、以下のセキュリティ上の懸念があります：

1. **統計的区別可能性**: ファイル追加ごとにファイルサイズが変化することで、ファイル内容に関する情報が漏洩する可能性
2. **タイミング攻撃**: 初期化と更新で処理時間が大きく異なることでサイドチャネル攻撃の可能性
3. **一貫性の欠如**: 暗号化ファイルの構造が常に同じではないため、解析が容易になる可能性
4. **ファイル関係性の漏洩**: 複数の暗号ファイルが存在する場合に関連性が推測される可能性
5. **ファイルタイプ識別リスク**: 初期化ファイルと暗号化済みファイルが外部から区別可能であり、どのファイルが実データを含むか特定される可能性
6. **コード混在リスク**: 過去の形式と新しい形式のコードが混在することで、古い脆弱な実装が使用されるリスクが生じます

## セキュリティ理念との乖離

現状の実装では、設計書の以下の重要なセキュリティ理念が実装されていません：

1. **MAP 決定論的生成原則**: パーティションキーとパスワードから全てのシェア位置情報が決定論的に生成される設計になっていないため、ファイル内でのシェア位置指定が冗長
2. **統計的区別不可能性**: 初期状態でランダムなゴミデータがないため、文書追加時の統計的区別が可能になっている
3. **二重の MAP 構造**: 設計書にある「第 1 段階 MAP（パーティションマップキー）」と「第 2 段階 MAP（パスワード）」の連携が不十分
4. **ファイル混在保管原則**: 設計ではファイル A とファイル B が同一の暗号ファイル内に混在して保管されることが想定されているが、これが明示的に実装されていない
5. **区別不能性原則**: 初期化ファイルと暗号化済みファイルが区別できないようにするという基本原則が守られていない
6. **コード純粋性原則**: セキュリティ上の欠陥を含む古いコードは完全に削除し、新たなセキュアな実装のみを残すという原則が守られていない

## 必要な改善点

1. 初期化時に完全な暗号化ファイルの雛形を生成する
2. すべてのシェア空間をランダムなゴミデータで埋める
3. シェアの格納方法を最適化する
4. ファイル命名方法を改善し、上書きを防止する
5. 多段 MAP の原理に完全準拠したシェア位置決定方式を実装
6. ファイル A とファイル B が同一の暗号ファイル内に混在保管される仕組みを明示的に実装する
7. 過去形式との互換性は一切考慮せず、セキュリティ基準から逸脱した実装を許容しない
8. 初期化ファイルと暗号化済みファイルが外部から区別できないよう、ファイル構造とヘッダー情報を統一する
9. 過去形式に関連するすべてのコードをコードベースから完全に削除し、新しい実装のみを残す

これらの改善により、暗号化システムのセキュリティと効率性を向上させることが可能です。過去形式はセキュリティ基準から逸脱した実装であるため、互換性は一切考慮せず、設計書の理念に完全準拠した新形式のみをサポートします。初期化ファイルと暗号化済みファイルが外部から区別できないようにすることで、どのファイルに実データが含まれているかという情報漏洩を防止し、システム全体のセキュリティを強化します。また、すべての過去形式関連コードを完全に削除することで、セキュリティ上の脆弱性を含む古い実装が誤って使用されるリスクを排除し、クリーンで安全なコードベースを確保します。
