# シャミア秘密分散法による複数平文復号システム テスト仕様書

## 1. テスト目的

シャミア秘密分散法による複数平文復号システムの実装が、仕様通りに動作することを検証するためのテストフレームワークを提供します。このテストは、セキュリティ要件と機能要件の両方を検証します。

## 2. テスト規約

### 2.1 テスト実行規約

- テスト完了後、`/method_13_shamir_multi_plaintext_system/IMPLEMENTATION_NOTES.md` のフォーマットに準じたレポートを `/method_13_shamir_multi_plaintext_system/tests/test_report` ディレクトリに生成する
- テストはメインモジュールからレポートに必要なコンポーネントを読み込んで実行する
- 毎回のテスト実行ではレポート項目の全てをテストする
- テストに採用する値は `/method_13_shamir_multi_plaintext_system/shamir/constants.py` のみを使用する

### 2.2 テストレポート命名規則

テストレポートのファイル名は以下の形式とする：

```
test_report_{YYYYMMDD}_{HHMMSS}.md
```

例：`test_report_20250510_123045.md`

### 2.3 テスト実行方法に関する規約

- テストは実際の CLI に引数を渡した結果で実行すること
- コードのバイパスを行ったり、バックドアを設けて結果を偽装することは禁止する
- 全てのテストは実際のシステム動作を正確に反映する形で実施すること
- モックやスタブの使用は、外部依存のあるコンポーネントに限定し、コア機能のテストでは使用しないこと

### 2.4 テスト失敗時の対応規約

- テスト失敗時は、すぐに修正を開始せず、まず失敗の事実をレポートに詳細に記載すること
- 失敗レポートには以下の内容を含めること：

  1. 失敗したテストの名称とパラメータ
  2. 期待された結果と実際の結果の差異
  3. その時点で把握できる原因分析
  4. 推奨される対策案（複数ある場合は優先順位付け）
  5. 関連する可能性のある他の機能への影響

- **重要警告**: 安直にテストの失敗に対する修正を行うことは厳禁とする。理由：

  1. 暗号システムでは表面的な修正が深刻なセキュリティホールを生み出す可能性がある
  2. 複雑に絡み合った依存関係により、一部の修正が他の機能に予期せぬ影響を与える
  3. シャミア秘密分散法のような数学的基盤に基づくシステムでは、安易な修正が暗号学的安全性を損なう恐れがある
  4. 失敗の根本原因を特定せずに行った修正は、同様の問題を別の形で再発させる

- テスト失敗への対応は、以下のプロセスに従うこと：
  1. 完全な失敗レポートの作成
  2. セキュリティ担当者とアーキテクトによるレビュー
  3. 対策案の数学的・セキュリティ的検証
  4. 承認された修正の実装
  5. 修正後の完全な再テスト

## 3. テスト範囲

### 3.1 現在のテスト対象機能

現在のテスト対象は以下の機能のみです：

1. 暗号書庫生成（createCryptoStorage）
   - **機能テスト**
     - パーティション分割
     - パーティションマップキー生成
     - ガベージシェア配置
     - 第 1 段階 MAP 生成
   - **セキュリティテスト**
     - 統計的区別不可能性検証：ガベージシェアと有効シェアが統計的に区別不可能であることを確認
     - タイミング攻撃耐性：暗号書庫生成プロセスが入力パラメータによらず一定時間で完了することを検証
     - パターン認識耐性：生成されたシェア値や配置パターンに統計的な偏りがないか検証
     - 異常入力耐性：不正な入力パラメータに対して適切にエラー処理されることを確認

**注意**: 暗号書庫生成（createCryptoStorage）のテスト内容と期待される結果は、`/method_13_shamir_multi_plaintext_system/tests/test_report_template.md` に定義されている形式に従って評価・報告されます。

### 3.2 現在のテスト範囲外の機能

以下の機能は現在テスト範囲外です：

1. **暗号書庫更新（updateCryptoStorage）**

   - 多段エンコード
   - シャミア法シェア生成
   - 第 2 段階 MAP 生成
   - シェア配置
   - バックアップ処理

2. **暗号書庫読取（readCryptoStorage）**
   - シェア選択
   - シャミア法復元
   - 多段デコード
   - JSON 復元

これらの機能は、暗号書庫生成機能が正常に動作することを確認した後、将来的なテストフェーズで検証される予定です。

### 3.3 将来的な統合テスト計画

以下の統合テストは、すべての基本機能のテストが完了した後に実施予定です：

1. A 領域書込・読取テスト
2. B 領域書込・読取テスト
3. A/B 独立性検証テスト
4. 大容量データテスト
5. 障害復旧テスト

## 4. テスト環境・条件

各テスト実行時に以下の条件を満たしていることを確認する：

- PARTITION_SIZE: シャミア法パーティションのサイズ
- ACTIVE_SHARES: アクティブシェアの数
- GARBAGE_SHARES: ガベージシェアの数
- UNASSIGNED_SHARES: 未割当シェアの数
- CHUNK_SIZE: チャンクサイズ (バイト)
- BACKUP_RETENTION_DAYS: バックアップ保持日数
- ハッシュアルゴリズム: 使用するハッシュアルゴリズム
- 暗号化アルゴリズム: 使用する暗号化アルゴリズム

## 5. テスト実行方法

テスト実行は以下のコマンドにより行われる：

```bash
cd /path/to/secret-sharing-demos-20250510/method_13_shamir_multi_plaintext_system
python -m tests.test_runner
```

## 6. 期待される結果

### 6.1 テスト成功時の期待される結果

全てのテストが成功し、以下の条件を満たすこと：

1. 異なるパーティション間でデータが漏洩しないこと
2. ガベージシェアと有効シェアが統計的に区別できないこと
3. パーティションキーとパスワードが正しい場合のみ、復号が成功すること
4. 複数文書の管理と独立した復号化が正常に機能すること
5. テストレポートが期待通りに生成されること

### 6.2 テスト失敗時の期待される結果

テストが失敗した場合は、以下のような詳細な失敗レポートが生成されることが期待されます：

1. **失敗事象の正確な記録**

   - 失敗したテストケースの完全な識別情報
   - 失敗が発生した正確な時点とコンテキスト
   - 実行環境パラメータの完全な記録
   - 関連するログと診断情報

2. **期待値と実際値の比較**

   - テストが期待した結果の詳細
   - 実際に観測された結果の詳細
   - 両者の差異の具体的な分析
   - 失敗した検証条件の正確な特定

3. **原因分析と仮説**

   - 問題の根本原因に関する初期分析
   - 考えられる仮説のリスト（優先順位付け）
   - 各仮説の技術的根拠と妥当性評価
   - 追加的な診断テストの提案

4. **セキュリティインパクト評価**

   - 失敗が暗号学的安全性に与える潜在的影響の分析
   - 他のシステムコンポーネントへの波及効果の評価
   - 攻撃可能性の査定（該当する場合）
   - 緩和策の提案

5. **修正アプローチの提案**
   - 修正のための推奨アプローチ（複数ある場合は優先順位付け）
   - 各アプローチのメリット・デメリットの分析
   - 修正の検証方法の提案
   - 修正後の完全な再テスト計画

テスト実行スクリプトは、失敗したテストケースが発生した場合でも継続して実行され、可能な限り多くのテストケースの結果を収集することが期待されます。これにより、一度のテスト実行で複数の問題を特定できるようにします。

## 7. 追加情報

テスト実行時に生成されたデータやログは、テストケースの終了後に適切に削除されます。ただし、障害検出時やデバッグ目的のために、一部のデータが `test_report` ディレクトリに保存される場合があります。

### 7.1 CLI 出力に関する備考

- CLI からの出力ファイルは `/Users/dev/works/VSCode/secret-sharing-demos-20250510/method_13_shamir_multi_plaintext_system/output` ディレクトリに保存されます
- すべてのテスト実行結果は常にこのディレクトリに出力されます
- **重要**: 出力ファイルは承認されたもののみ削除可能であり、それ以外のファイルを削除することはできません
- 出力ファイルには、テスト日時、実行パラメータ、結果サマリーなどの重要情報が含まれるため、監査証跡として保持されます
- 出力ディレクトリの内容は定期的にバックアップされます
