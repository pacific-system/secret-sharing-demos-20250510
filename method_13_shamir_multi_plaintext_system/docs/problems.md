# シャミア秘密分散法による複数平文復号システム：実装上の問題点

## 背景

シャミア秘密分散法による複数平文復号システムは、単一の暗号化ファイルから異なるパスワードを使用して異なる平文（JSON 文書）を復号可能にする技術です。このシステムは「パーティションマップキーによる MAP 生成とパスワードによるマップ生成」という多段 MAP 方式を核心としています。

最近の実装改善として、CLI インターフェースを簡素化し、`--user`フラグの削除と`--partition-key-a/b`を単一の`--partition-key`に統合しました。しかし、実装テスト中にいくつかの重要な問題が発見されました。

## 発見された問題点

### 1. 過大なシェア ID 空間サイズ

**問題**：
元の実装では`SHARE_ID_SPACE = 2**32 - 1`（約 43 億）という大きなシェア ID 空間を使用していました。これにより、実行時にメモリ消費が過大になり、プログラムが Kill される結果となっていました。

**確認方法**：
デバッグ出力を追加し、シェア ID 空間サイズを 1000 に縮小したところ、プログラムが正常に動作するようになりました。

**影響**：

- プログラムの実行が不可能
- メモリ使用量の急激な増加
- システムによるプロセスの強制終了

**修正案**：
シェア ID 空間のサイズを適切な値（例：10,000 程度）に設定し、シェア数とセキュリティのバランスを取るべきです。

### 2. MAP の生成ロジックの不整合

**問題**：
`stage1_map`関数がパーティションキーに基づいてシェア ID を選択しますが、選択パターンが一貫していません。そのため、同じパーティションキーとパスワードであっても、暗号化したファイルが後で復号できない場合があります。

**確認方法**：

- `stage1_map`関数が各実行で異なる選択を行うことをデバッグログで確認
- 同じファイルに対して繰り返し暗号化/復号を行うと、成功率が低い

**影響**：

- 信頼性の低下：同じキーとパスワードでも復号できない場合がある
- 複数平文共存時の整合性問題：一方の文書の更新が他方の文書のアクセス不能を引き起こす

**修正案**：

- `stage1_map`関数の乱数生成と選択アルゴリズムの見直し
- シード値から ID 生成までの決定論的プロセスを厳密に固定
- テストケースを追加し、繰り返し暗号化/復号操作での一貫性を確保

### 3. 更新処理の問題

**問題**：
ファイル更新処理が正しく動作せず、特に複数のユーザー文書が共存する場合に問題が生じます。具体的には、更新後のファイルでは一部のユーザー文書しか復号できなくなります。

**確認方法**：

- A 用文書で暗号化し、B 用文書で更新後
- B 用パスワードとキーでは開けるが、A 用では開けない

**影響**：

- 複数ユーザー文書の共存が実質的に不可能
- データ喪失リスク：更新操作が既存データを破壊する可能性

**修正案**：

- 他のシェアを維持する処理ロジックの見直し
- 特に stage1_map の結果に基づく「他のシェアの選択処理」の修正
- 更新処理の原子性強化（全ユーザーデータの一貫性確保）

### 4. 依存関係の管理不備

**問題**：
`update.py`モジュールで必要な`base64`モジュールがインポートされていませんでした。

**確認方法**：
更新処理実行時に "name 'base64' is not defined" エラーが発生

**影響**：

- 更新機能が完全に動作しない
- エラーメッセージが不明確でデバッグが困難

**修正案**：

- 各モジュールの依存関係の包括的レビュー
- 自動テスト導入による未使用/不足インポートのチェック

### 5. パーティションキーの本来機能の未実装

**問題**：
パーティションキーは、各ユーザーに割り当てられた最大領域を復元するためのキーであり、互いの最大領域に対して不可侵な MAP を毎回同じように生成できるためのキーです。しかし、この核心的な機能が正しく実装されていません。

**確認方法**：

- `keys.json`のパーティションキー定義が適切に機能していない
- 同じパーティションキーを使用しても、異なる実行時に異なる MAP 領域が生成される

**影響**：

- 複数ユーザー間でのシェア領域の分離が不完全
- 同じパーティションキーでも実行ごとに異なる領域にアクセスしてしまう可能性
- セキュリティモデルの根幹部分が機能していない

**修正案**：

- パーティションキーから決定論的に領域を分割するアルゴリズムの再設計
- パーティション空間の明確な分離と相互独立性の確保
- 各パーティションキーが常に同じ領域を生成することを検証するテスト

### 6. 暗号化ファイル形式の冗長性

**問題**：
暗号化ファイル構造に不要なメタデータが含まれています。シェア値のみが必要ですが、現在の実装では`chunk_index`や`share_id`のような冗長な情報も含まれています。

**確認方法**：

- `enc_combined.json`の構造を確認すると、各シェアに余分なメタデータが含まれている
- パーティションキーとパスワードから生成される MAP により、シェアの位置は自動的に特定可能なはず

**影響**：

- ファイルサイズの不必要な増大
- 実装の複雑化（余分なデータの管理が必要）
- 設計思想と実装の不一致

**修正案**：

- シェア値のみを保存する効率的なファイル形式に変更
- MAP により配列位置から自動的にシェアを特定する機構に修正
- 最小限の必要なメタデータ（ソルト値など）のみを保持

## 修正優先度

1. **最高優先度**: パーティションキーの本来機能の実装（システムの設計思想の根幹）
2. **高優先度**：MAP 生成ロジックの不整合修正（システムの信頼性に直結）
3. **高優先度**：更新処理の問題修正（データ損失防止のため）
4. **中優先度**：シェア ID 空間サイズの最適化（パフォーマンス向上）
5. **中優先度**：暗号化ファイル形式の最適化（効率性と設計思想の整合）
6. **低優先度**：依存関係の管理改善（すでに修正済み）

## 今後のアクション

1. パーティションキーの機能を正しく実装するためのアルゴリズム再設計
2. ユニットテストの拡充：特に暗号化 → 更新 → 復号のフローを検証するテスト
3. シェア ID 選択アルゴリズムの再設計：一貫性とセキュリティのバランスを考慮
4. 暗号化ファイル形式の最適化：不要なメタデータの削除
5. メモリ使用量の最適化：大規模ファイル処理でもメモリ効率を確保
6. エラーハンドリングの強化：例外処理とエラーメッセージの明確化

## 結論

シャミア秘密分散法による複数平文復号システムは理論的には優れたアプローチですが、現在の実装にはいくつかの重要な問題があります。特に、パーティションキーの本来機能が実装されていないこと、MAP 生成の一貫性の問題、更新処理における複数文書の保全の問題、および暗号化ファイル形式の冗長性が主な課題です。これらの問題を解決することで、システムの信頼性と使いやすさが大幅に向上するでしょう。
