# シャミア秘密分散法による複数平文復号システム設計書

## 4. セキュリティ解析

### 4.1. 脅威モデル

本システムが想定する脅威モデルは以下の通りです：

1. **暗号書庫へのアクセス**：

   - 攻撃者は暗号書庫ファイルへの読み取りアクセス権を持つ
   - 複数バージョンの暗号書庫ファイルを比較可能
   - ファイルシステムのメタデータ（タイムスタンプなど）にアクセス可能

2. **静的解析**：

   - 攻撃者はソースコードへのアクセス権を持つ（オープンソースソフトウェアとして公開）
   - アルゴリズムと実装の詳細を完全に理解している

3. **限定的な動的解析**：

   - 攻撃者は自身の暗号書庫を作成して実験可能
   - システムの挙動を観察して推論可能

4. **想定外のアクセス**：
   - パーティションマップキー A のみ取得（パスワード A なし）
   - パスワード A のみ取得（パーティションマップキー A なし）
   - A 用のパーティションマップキーとパスワードは取得したが、B 用は未取得

本システムは、攻撃者が暗号書庫ファイルに完全にアクセスできる状況でも、適切なパスワードとパーティションマップキーがない限り、保護された情報にアクセスできないことを保証します。

### 4.2. セキュリティ保証

本システムが提供するセキュリティ保証は以下の通りです：

1. **機密性**：

   - パスワードとパーティションマップキーの両方が必要な 2 要素保護
   - パーティションマップキーは**全文そのままのパスワード（生のパスワード）**で暗号化され、第 2 段階 MAP 生成には**必ず処理されたパスワード**が使用される（**開発者は第 2 段階 MAP 生成に生のパスワードを誤って使用してはならない**）
   - 暗号書庫からの情報漏えいなし（統計的区別不可能性）

2. **完全性**：

   - WAL 方式による更新処理の整合性保証
   - 更新中の障害からの復旧機能

3. **可用性**：

   - コード障害や処理中断からの自動復旧
   - ロックファイルによる並列実行保護

4. **否認不可能性**：
   - 本システムは否認不可能性を直接サポートしない
   - 必要に応じて上位レイヤーで実装すべき

### 4.3. 暗号プリミティブ

本システムで使用される主要な暗号プリミティブは以下の通りです：

1. **シャミア秘密分散法**：

   - GF(2^8) 上での多項式補間を使用
   - 多項式の次数は `ACTIVE_SHARES - 1`
   - 全シェア使用方式（閾値概念は使用しない）

2. **対称暗号**：

   - パーティションマップキーの暗号化に AES-256-GCM を使用
   - **全文そのままのパスワード（生のパスワード）**を使用

3. **ハッシュ関数**：

   - パスワード処理に SHA-256 を使用
   - 第 2 段階 MAP 生成には**必ず処理されたパスワード**を使用（**開発者は生のパスワードを誤って使用してはならない**）

4. **鍵導出関数**：

   - パスワードからの鍵導出に PBKDF2 を使用
   - ソルト値とイテレーション回数は設定可能

5. **固定長シリアライズ暗号化**：
   - データの統計的特徴を隠蔽するためにパーティションマップキーを使用した固定長暗号化を実施
   - 可変長データを固定長に変換し、データ量からの情報漏えいを防止

### 4.4. 攻撃シナリオと対策

#### 4.4.1. 統計解析攻撃

**攻撃シナリオ**:

- 攻撃者が暗号書庫ファイル内のデータの統計的特性を分析
- シェアのパターンから A/B 所属を推測しようとする

**対策**:

- 全シェアが統計的に区別不可能（同一の確率分布）
- ガベージシェアと有効シェアが区別できない
- パーティションマップキーを使用した固定長暗号化により、データの統計的特徴を完全に隠蔽

#### 4.4.2. 差分解析攻撃

**攻撃シナリオ**:

- 攻撃者が同一暗号書庫の複数バージョンを比較
- 変更された部分から有効シェアを特定しようとする

**対策**:

- 更新時に影響範囲外のシェアも確率的に再生成
- 各更新は独立したリフレッシュプロセスを含む
- 更新時に使用する一時ファイルも暗号化

#### 4.4.3. サイドチャネル攻撃

**攻撃シナリオ**:

- 処理時間やメモリアクセスパターンの観察
- 電力消費や電磁波放射からの情報漏えい

**対策**:

- 処理時間が入力に依存しない一定時間アルゴリズム
- メモリアクセスパターンが入力に依存しない実装
- 機密データのメモリ内消去処理

#### 4.4.4. 部分的知識からの攻撃

**攻撃シナリオ**:

- 攻撃者がパーティションマップキーのみを取得
- 攻撃者がパスワードのみを取得

**対策**:

- 2 要素保護方式：両方の要素が揃わないと復号不可能
- パーティションマップキーは**全文そのままのパスワード（生のパスワード）**で暗号化
- 第 2 段階 MAP 生成には**必ず処理されたパスワード**を使用（**開発者は生のパスワードを誤って使用してはならない**）
- 部分的な知識では暗号書庫内のどの部分にアクセスすべきか不明

### 4.5. セキュリティの限界

本システムには以下のセキュリティ限界があります：

1. **暗号学的前提**：

   - 使用する暗号プリミティブの安全性に依存
   - 将来の量子計算機攻撃に対する脆弱性（特に対称暗号）

2. **パスワード強度**：

   - 弱いパスワードはブルートフォース攻撃に脆弱
   - パスワード選択は本システムの責任外

3. **鍵管理**：

   - パスワードとパーティションマップキーの安全な管理は本システムの責任外
   - 漏えいした場合の対策は提供しない

4. **実装攻撃**：

   - マルウェアやキーロガーによるパスワード盗難
   - メモリダンプ攻撃による一時的に展開された平文へのアクセス

5. **強制開示**：
   - 法的強制や物理的強制による開示要求
   - 秘匿性よりも個人の安全を優先すべき状況

### 4.6. セキュリティ監査と検証

本システムのセキュリティを確保するために、以下のプロセスを推奨します：

1. **コード監査**：

   - 外部の専門家によるセキュリティコード監査
   - 自動化されたコード解析ツールの使用

2. **脆弱性テスト**：

   - ファジング（境界値や異常値のテスト）
   - 悪意あるユーザーを想定したテスト

3. **暗号アルゴリズムのレビュー**：

   - 使用する暗号プリミティブの定期的な見直し
   - 新しい攻撃手法出現時の影響評価

4. **ドキュメント検証**：
   - セキュリティ文書の正確性検証
   - 実装とドキュメントの一致確認

### 4.7. 将来的なセキュリティ強化

将来のバージョンで検討すべきセキュリティ強化策は以下の通りです：

1. **量子耐性**：

   - ポスト量子暗号アルゴリズムの採用
   - 格子ベースまたはハッシュベースの署名方式

2. **鍵強化**：

   - 秘密分散のより高度な実装
   - メモリハード関数（Argon2 など）の採用

3. **2 段階認証の拡張**：

   - ハードウェアトークンとの統合
   - 生体認証オプションの追加

4. **セキュアエンクレーブ利用**：

   - TPM や SGX などのハードウェアセキュリティ機能活用
   - 機密計算のためのセキュアエンクレーブ使用

5. **監査ログ**：
   - セキュアな監査ログ機能の追加
   - アクセス試行の記録（オプション機能）

これらのセキュリティ強化策は、ユーザープライバシーとシステムの使いやすさのバランスを考慮しながら実装すべきです。
