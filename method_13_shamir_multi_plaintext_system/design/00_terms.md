# シャミア秘密分散法による複数平文復号システム設計書

## 0. 用語集

本設計書で使用される重要な用語と概念の定義を以下に示す：

### 0.1. 暗号理論の基本概念

| 用語                   | 定義                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **シャミア秘密分散法** | Adi Shamir が 1979 年に発表した暗号技術。秘密情報を複数の「シェア」に分散し、定められた閾値以上のシェアが揃った場合にのみ元の情報を復元できる仕組み。k 個の点から（k-1）次多項式を一意に決定できるという数学的性質を利用している。本システムでは全シェアを常に使用する実装を採用。                                                                                   |
| **閾値（threshold）**  | シャミア秘密分散法において、秘密情報を復元するために必要な最小シェア数。閾値を k とすると、k 個以上のシェアがあれば秘密を復元できるが、k-1 個以下のシェアからは秘密に関する情報は一切得られない。本システムでは`ACTIVE_SHARES`がこれに相当し、全てのシェアを使用する方式を採用している。                                                                             |
| **統計的区別不可能性** | 暗号ファイル内の異なる文書（A/B）のシェアや未割当領域のシェアが統計的に区別できない性質。外部観察者がどのシェアがどの文書に属するか識別できないことを保証する。                                                                                                                                                                                                      |
| **ケルクホフの原理**   | 暗号システムのセキュリティはアルゴリズムの秘匿ではなくキー（パスワード）の秘匿のみに依存すべきとする原理。本システムはこの原理に厳格に従い、第 2 段階 MAP にそのまま従い、その正当性を評価しない設計となっている。これにより、システムのセキュリティがアルゴリズムの秘匿ではなく適切なパスワードとパーティションマップキーの組み合わせにのみ依存することを保証する。 |

### 0.2. データ変換と基本単位

| 用語                   | 定義                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **チャンク（chunk）**  | 平文データを一定サイズの断片に分割したもの。本システムでは 64 バイト固定長に分割し、各チャンクをシャミア秘密分散法の入力として使用する。チャンク分割は、大きなデータを扱いやすいサイズに分割するための前処理であり、暗号化前の準備段階に位置する。重要な点として、分割されるチャンク数は正確に`ACTIVE_SHARES`個となるよう調整される。                                                                                                                                                                                                                                                                                                                          |
| **シェア（share）**    | シャミア秘密分散法によって生成される数学的な断片。各シェアは（ID, 値）のペアで構成され、ID は x 座標、値は y 座標に相当する。これらの点を集めることで元の多項式（秘密情報を含む）を再構築できる。本システムでは、元データをチャンクに分割した後、各チャンクに対してシャミア秘密分散法を適用してシェアを生成する。各ファイル（A/B）に対して、`ACTIVE_SHARES`パラメータで設定した数だけシェアが存在し、全てのシェアが復号に使用される。                                                                                                                                                                                                                          |
| **固定サイズチャンク** | 本システムの核心的な設計要素。データを常に同じサイズ（64 バイト）に分割して処理することで、統計的区別不可能性を確保し、サイドチャネル攻撃に対する耐性を高める。全てのチャンクは厳密に同一サイズで処理される。チャンク数は正確に`ACTIVE_SHARES`個となるように調整され、各チャンクに対しシャミア法を適用して`ACTIVE_SHARES`個のシェアが生成される。これにより、チャンク数とシェア数が一致する設計が実現され、システムの堅牢性が向上する。                                                                                                                                                                                                                        |
| **ガベージシェア**     | 本システムにおける意図的に生成された無意味なデータ。「パーティション内ガベージシェア」と「未割当領域ガベージシェア」の 2 種類がある。これらはシステムの安全性を高めるための偽装データであり、統計的に有効なシェアと区別できないように設計される。システムのセキュリティを強化し、攻撃者に有効なシェアを特定させないための攪乱要素として機能する。`GARBAGE_SHARES`と`UNASSIGNED_SHARES`パラメータによって量が制御される。**重要**: システム初期化時点では全てのシェア領域がガベージシェアで埋め尽くされており、暗号化操作を行った際に必要な部分のみが有効なシェアに置き換えられる。これにより初期化済みファイルと暗号化済みファイルの区別が外部から困難になる。 |
| **有効シェア**         | `ACTIVE_SHARES`により数量が確定する、各ファイル（A/B）が実際に暗号データを格納できるシェア。暗号化できる最大データ容量は`ACTIVE_SHARES × CHUNK_SIZE`で計算される。各ファイルは同一数の有効シェアを持ち、完全な対称性が保証される。パスワードと第 2 段階 MAP と`ACTIVE_SHARES`により、パーティション内のどのシェアが有効シェアとして使用されるかが決定される。                                                                                                                                                                                                                                                                                                  |

### 0.3. システム構造と空間設計

| 用語                           | 定義                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **暗号書庫**                   | `CryptoStorage`とも呼び、本システムにおける暗号化データの保存単位。A/B それぞれの文書を格納する領域とそのどちらも格納しない領域を持ち、シャミア秘密分散法によって暗号化されたシェアの集合として構成される。                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **パーティション空間**         | システム内で使用されるシェア ID の全体集合。ファイル A 用、ファイル B 用、未割当ての 3 種類に分割される。初期化時に指定の集合が完成し以降集合の大きさが変わることない。                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **各パーティション分布**       | 初期化時に割り当てられる、ファイル A 用とファイル B 用のシェア ID 分布域のこと。各パーティション分布はお互いに重複せず、独立した領域として設計される。旧称は「各パーティション領域」であったが、空間的な「領域」という表現よりも統計的な「分布」という表現が本システムの本質をより適切に表している。                                                                                                                                                                                                                                                                                                                                              |
| **ファイルパーティション設計** | システム全体の基盤となる整数値による明示的な設計。以下の値が`constants.py`で定義される：<br>- `ACTIVE_SHARES`：各ファイル(A/B)用有効シェア数（整数、共通値）<br>- `GARBAGE_SHARES`：各ファイル(A/B)用ゴミデータ数（整数、共通値）<br>- `PARTITION_SIZE = ACTIVE_SHARES + GARBAGE_SHARES`：各ファイル(A/B)用パーティション総サイズ（自動計算）<br>- `UNASSIGNED_SHARES`：未割当シェア数（整数）、AB どちらにも所属しないゴミデータ<br>これらにより`SHARE_ID_SPACE = PARTITION_SIZE * 2 + UNASSIGNED_SHARES`が自動計算される。この設計は常に有効シェア数とゴミデータ数から各パーティションサイズが決定され、ファイル A/B に完全な対称性を持たせる。 |

### 0.4. マッピングシステムと鍵管理

| 用語                         | 定義                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **MAP（マップ）**            | 混在するシェア群の中から、必要なシェア全てを特定するための対応表または関数。特定の文書を復号する際に必要なシェアを一括して選別するために使用される。本システムでは第 1 段階 MAP と第 2 段階 MAP の多段構造を採用し、それぞれが異なる責務を担う。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **パーティションマップキー** | システム初期化時に、まず暗号書庫ごとに一意の第 1 段階 MAP（シェア ID の分布域）が生成され、そこから逆算して作られる秘密の種（シード）。つまり、復号時に同じ第 1 段階 MAP を再生成するための情報を保持するキーである。暗号書庫の生成ごとに第 1 段階 MAP の分布は変わるため、異なる暗号書庫では同じパーティションマップキーを使用しても異なる ID 分布が生成される。例えば「A 用パーティションマップキー」からは「A 用シェア」の ID 分布域が決定論的に再現され、同じキーからは常に同じ ID 分布域が生成されるため、復号時に正しい分布域を特定できる。重要な点として、このキーからは領域内での実際のシェアの分布状況（どの ID が実際に使用されているか）は特定できない。単なる ID の集合ではなく、第 2 段階 MAP が分布できる最大の分布域を決定するための元データとして機能する。                   |
| **パスワード**               | ファイル A またはファイル B の第 2 段階 MAP の生成に使用される秘密の種（シード）。特定のファイルが使用するシェアを決定する鍵として機能し、どのシェアが実際に復号に使用されるかを特定する。第 1 段階 MAP が決まった後、パスワードがその分布域内の具体的なシェア選択を決定づける。第 2 段階 MAP は、第 1 段階 MAP、パスワード、および`ACTIVE_SHARES`の値の組み合わせによって決定される。これら 3 つの要素が同じであれば、常に同じシェアが選択される決定論的な特性を持つ。                                                                                                                                                                                                                                                                                                                       |
| **多段 MAP 方式**            | 本システムの核心技術。パーティションマップキーによる第 1 段階 MAP とパスワードによる第 2 段階 MAP を組み合わせて、必要なシェアを特定する方式。この方式の重要な特徴は：<br>1. 第 1 段階 MAP は暗号書庫ごとに異なるマッピングを生成し、同じパーティションマップキーを使用しても異なる暗号書庫では異なる ID 分布となる<br>2. 第 2 段階 MAP は第 1 段階 MAP に対して相対的な分布を生成し、パスワードが同じなら第 1 段階 MAP に対して毎回同じ分布のシェアを選択する<br>3. 上記の組み合わせにより、暗号書庫が異なれば、同じパスワードとパーティションマップキーを使用しても復号に使用されるシェアの絶対位置が異なる結果となり、セキュリティが向上する<br>この仕組みにより、異なる暗号書庫間でのシェア位置の相関性がなくなり、一つの暗号書庫が漏洩しても他の暗号書庫のシェア位置の推測が困難になる。 |
| **第 1 段階 MAP**            | 暗号書庫生成時に最初に決定される MAP であり、パーティションマップキーはこの MAP を後で復元するために生成される逆算キーである。全シェア空間を A/B 用パーティションと未割当領域に分割し、それぞれが互いに不可侵となるよう設計される。この段階では`PARTITION_SIZE`によって決定される固定サイズのシェア領域が割り当てられる。この段階の主要な責務は：<br>1. 各ユーザー（A/B）に割り当てられた独自の領域（PARTITION_SIZE 分のシェア ID 空間）を不可侵に分離<br>2. ユーザー間でシェア領域が重複しないよう厳密に区分<br>3. 暗号書庫生成時に決定した MAP を復号時にパーティションマップキーから正確に復元できるよう設計<br>4. 他ユーザーのデータに対する完全な分離と不可侵性を保証                                                                                                                    |
| **第 2 段階 MAP**            | パスワードから生成される MAP。第 1 段階で特定された候補シェア（PARTITION_SIZE 分のシェア ID 空間）の中から、実際に復号に使用するシェア（ACTIVE_SHARES 分）を選別する。パスワードに基づいて決定論的に選択され、同じパスワードと PARTITION_SIZE、ACTIVE_SHARES の値が変わらなければ毎回同じシェアが選択される。この段階の主要な責務は：<br>1. パスワードに基づいて第 1 段階で選択された領域内のシェアから`ACTIVE_SHARES`の数だけ決定論的に選別<br>2. 選択されたシェアから秘密情報（平文）を再構築するための正確な閾値分のシェアを特定<br>3. 同じパスワードで常に同じシェアが選択されるよう決定論的に動作<br>4. 統計的区別不可能性を維持しながら必要なシェアだけを効率的に特定                                                                                                                   |

### 0.5. データ処理とセキュリティ原則

| 用語                       | 定義                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **データフロー**           | 本システムでの情報処理の流れ：<br>1. 平文データ → チャンク分割（64 バイト固定長、合計で正確に`ACTIVE_SHARES`個のチャンクを生成）<br>2. 各チャンク → シャミア法適用 → `ACTIVE_SHARES`個のシェア生成（各チャンクが ACTIVE_SHARES 個のシェアに正確に変換される）<br>3. シェア群をファイルに保存（暗号化状態）<br><br>復号時は逆の流れとなる：<br>1. シェア群取得 → 特定の MAP に基づくシェア選択<br>2. 選択されたシェア → シャミア法逆適用 → チャンク復元<br>3. チャンク結合 → 平文データ復元                                                                                                                                                                                                                                                                                                                                                                   |
| **直交処理原則**           | 全ての処理ステップが互いに独立して一貫性を持ち、入力データの特性に左右されず、常に同一の方法で実行されることを保証する原則。入力サイズや内容に関わらず処理が同一であることで、サイドチャネル攻撃への耐性を提供する。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **直線的処理**             | 復号処理の途中で条件分岐や評価を含まず、同一のコードパスを通り抜ける処理方式。タイミング攻撃やサイドチャネル攻撃への耐性を持つ。直交処理原則を実現するための実装手法の一つ。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **全シェア使用方式**       | 従来のシャミア秘密分散法で一般的な「閾値方式」（n 個中 k 個のシェアで復元可能）とは異なり、本システムでは常に指定されたシェア全てを使用して復号する方式。これにより部分的なシェア漏洩への耐性が強化される。本システムでは、各チャンクが正確に`ACTIVE_SHARES`個のシェアに変換され、復号時には全てのシェアが必要となる。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **パスワード処理**         | あらゆる UTF-8 文字（漢字・絵文字等を含む）をサポートし、ハッシュ化して固定長に変換することで、文字セットや長さに依存しない一貫した処理を実現。入力に関わらず常に同一の処理パイプラインで扱われる。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **メタデータ**             | 暗号化ファイルに保存される最小限の構成情報。このシステムではメタデータを極力少なくし、以下の情報のみを含む：<br>1. ソルト値（salt）：シェア生成に使用したソルト値<br><br>初期化時と暗号化・更新時で、このメタデータに変化は生じない。これにより、初期化ファイルと暗号化済みファイルが外部から区別できないようになっている。<br><br>以下のメタデータは情報漏洩リスクのため意図的に除外されている：<br>- **magic**：固定値はファイルの特性を示す手がかりになるため除外<br>- **created_at**：作成時刻の情報漏洩リスクがあるため除外<br>- **share_id_space**：配列の長さから計算可能なため冗長<br>- **total_chunks**：多段 MAP から導出可能なため冗長<br>- **threshold**：本システムでは閾値の概念は使用せず、常に全シェアを使用<br>- **file_type**：ファイル種別はパーティションキーから導出可能なため不要<br>- **version**：互換性は別の方法で処理するため不要 |
| **完全固定長シリアライズ** | Base64 エンコード後のデータを固定長形式に変換する処理。シェア ID やシェア値などすべての要素を厳密に固定長でシリアライズし、ファイルサイズの一貫性と統計的区別不能性を確保する。データ量に関わらず常に同一のシリアライズ処理を適用する。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **一時ファイル**           | 更新処理中に使用される中間ファイル。シャミア秘密分散法で暗号化され、処理完了時に削除される。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

### 0.6. 処理と操作

| 処理・原則             | 説明                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **生成処理**           | `createCryptoStorage`とも呼び、暗号書庫を初期状態で作成し、A/B 両領域の基盤構造を確立するプロセス。全シェア空間にガベージシェアを配置し、統計的区別不可能性の基盤を確立する。暗号書庫生成時点では有効データは含まれず、後続の更新操作により有効データが書き込まれる。                                                                                                                                    |
| **更新処理**           | `updateCryptoStorage`とも呼び、パーティションマップキーが示す領域にデータを格納するプロセス。平文データ（UTF-8 エンコードされた JSON）、対応するパーティションマップキー、パスワードを入力として受け取り、暗号書庫を更新する。                                                                                                                                                                           |
| **読取処理**           | `readCryptoStorage`とも呼び、第 2 段階 MAP が示す領域からデータを復号して取得するプロセス。対応するパーティションマップキーとパスワードを入力として受け取り、暗号書庫から平文データを復元する。                                                                                                                                                                                                          |
| **冪等性**             | 同一暗号書庫・同一パスワード・同一パーティションマップキーによる複数回の呼び出しが同一結果となる性質。更新処理（`updateCryptoStorage`）が持つ重要な特性の一つであり、操作が何度実行されても結果が変わらないことを保証する。                                                                                                                                                                              |
| **履歴無依存**         | 初回更新も 2 回目以降の更新も同一の処理パスをたどる性質。更新処理が前の状態を考慮せず、指定された MAP に完全に上書きする「状態認識なし」の設計と密接に関連している。                                                                                                                                                                                                                                     |
| **更新処理の許容事象** | 更新処理において正常な振る舞いとして許容される事象：<br>1. 全く関連のない暗号書庫を、関連のないパスワードで上書きして破壊する<br>2. 間違ったパスワードを使用して、異なる MAP で既存データを上書きする<br>3. 同じ暗号書庫内で A のデータを B のデータで上書きする<br>4. 空（未使用）の領域をデータで上書きする<br>5. 既に使用済みの領域を新たなデータで上書きする                                         |
| **読取処理の許容事象** | 読取処理において正常な振る舞いとして許容される事象：<br>1. 間違ったパスワードで読み取りを試み、無意味なデータを取得する<br>2. 存在しないデータ領域の読み取りを試み、ガベージシェアを取得する<br>3. A のパスワードを使って B のデータ領域にアクセスを試みる<br>4. 一部破損した暗号書庫から部分的なデータを読み取ろうとする<br>5. 異なるバージョンの暗号書庫を旧バージョンのアルゴリズムで読み取ろうとする |
