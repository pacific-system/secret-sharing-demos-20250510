# 初期化モジュール実装ガイド

## 初期化モジュールの目的

このモジュールはシステムの初期設定を行い、シェアトークン空間を構築します。シェアトークンを A 文書用、B 文書用、未割当に分割し、それぞれをセキュアに管理するための基盤を提供します。

## 主要な機能と要件

### 1. シェアトークン空間の設計と分割

- **分割比率**: A 用 30-40%、B 用 30-40%、未割当 20-40%
- **分散配置**: 連続範囲や偶数/奇数などの単純パターンを避け、ランダムに分散
- **安全性**: どの部分を切り取っても、A、B、未割当の識別が統計的に不可能

### 2. 出力データの独立性と安全性

- **セキュリティ分離**: A 文書と B 文書の両方を俯瞰できるマスターデータは出力しない
- **独立出力**: A 用シェアトークンと B 用シェアトークンは別々のファイルとして出力
- **高度暗号化**: シェアデータは高度に暗号化されたバイナリファイル形式で保存
- **パスワード保護**: 各シェアファイルはそれぞれ独立したパスワードで保護
- **情報分離**: 暗号化ファイル内に A 文書と B 文書の紐付け情報は一切残さない

### 3. シェアトークン生成とランダム性の確保

- **トークン形式**: シェアトークンは `9jfhsyenehgr6hkwhjyhbweey6d` のような単一行の文字列
- **暗号学的乱数**: 安全な乱数生成器を使用してシェアトークン空間を構築
- **反復検証**: 生成された分布の統計的特性を検証し、偏りがないことを確認
- **不可逆性**: 生成プロセスは一方向であり、トークンから元の割り当てを推測不可能

### 4. シェアトークンによる占有領域制御

- **占有領域マップ**: シェアトークンから占有できる可能性範囲のマップを生成可能
- **セキュリティモデル**: すべてのセキュリティはシェアトークンとパスワードの 2 要素に依存
- **アクセス制御**: 正しいシェアトークンとパスワードの組み合わせのみが正しい文書を復号可能
- **マッピング不要**: 暗号化ファイルには明示的なマッピング情報が不要（シェアトークンのみで十分）

## 主要関数の実装ガイド

### 1. シェアトークン空間の生成

```python
def generate_share_token_space(total_shares, ratio_a, ratio_b, ratio_unassigned):
    """
    シェアトークン空間を生成して分割

    Args:
        total_shares (int): 生成するシェアトークン総数
        ratio_a (int): A用シェアの比率
        ratio_b (int): B用シェアの比率
        ratio_unassigned (int): 未割当シェアの比率

    Returns:
        tuple: (a_tokens, b_tokens, unassigned_tokens) - 各カテゴリのシェアトークンリスト
    """
    # 1. 全トークンの生成（暗号学的に安全な乱数を使用）
    # 2. シャッフルして順序をランダム化
    # 3. 比率に基づいて分割
    # 4. 各セットを返却
```

### 2. シェアファイルの暗号化出力

```python
def encrypt_share_file(share_tokens, password, output_path):
    """
    シェアトークンリストを暗号化してファイルに保存

    Args:
        share_tokens (list): 暗号化するシェアトークンのリスト
        password (str): 暗号化に使用するパスワード
        output_path (str): 出力ファイルパス

    Returns:
        bool: 成功した場合はTrue
    """
    # 1. シェアトークンリストをバイナリ形式にシリアライズ
    # 2. パスワードから強力な鍵を導出
    # 3. 乱数IV(初期化ベクトル)を生成
    # 4. AES-GCMなど認証付き暗号化を適用
    # 5. メタデータ（バージョン、アルゴリズム情報）を追加
    # 6. バイナリファイルとして保存
```

### 3. シェアファイルの検証

```python
def verify_share_file(file_path, password):
    """
    暗号化されたシェアファイルを検証

    Args:
        file_path (str): 検証するファイルのパス
        password (str): 復号用パスワード

    Returns:
        bool: ファイルが有効な場合はTrue
    """
    # 1. ファイルからメタデータを読み取り
    # 2. パスワードから鍵を再導出
    # 3. 認証を検証
    # 4. 内容を復号
    # 5. フォーマット確認
```

## 実装上の制約とガイドライン

### 1. セキュリティ要件

- **識別不能性**: A 用、B 用、未割当のシェアトークンが統計的に区別できないこと
- **マスターデータの排除**: A、B 両方のシェアトークン情報を含むマスターファイルを出力しない
- **暗号強度**: 最低でも AES-256 レベルの暗号強度を確保
- **キーストレッチング**: パスワードからの鍵導出には強力な KDF（Argon2 など）を使用

### 2. ファイル出力形式

- **独立ファイル**: A 用、B 用のシェアトークンは別々のファイルに保存
- **バイナリ形式**: JSON ではなく、バイナリ形式で保存
- **認証タグ**: データの完全性と認証を確保するためのタグを含める
- **ファイル構造**: ヘッダ（メタデータ）、IV、暗号文、認証タグの構成

### 3. バックアップと冗長性

- **バックアップ推奨**: 初期化後のシェアファイルは安全にバックアップすることを強く推奨
- **エクスポート機能**: 必要に応じてプレーンテキスト形式でエクスポート可能（開発者オプション）
- **リカバリーメカニズム**: シェアファイル損失時のリカバリー手段を提供しない（セキュリティ上の理由）

## 出力ファイル形式の詳細

初期化モジュールが出力するシェアファイルは、以下の構造を持つバイナリファイルです：

```
[ファイルマジック (8バイト)] - 固定識別子
[バージョン (2バイト)] - ファイル形式バージョン
[アルゴリズム識別子 (2バイト)] - 使用暗号化アルゴリズム
[KDFパラメータ (可変長)] - 鍵導出関数のパラメータ
[IV (16バイト)] - 初期化ベクトル
[暗号化データ (可変長)] - 暗号化されたシェアトークンリスト
[認証タグ (16バイト)] - GCMモード認証タグ
```

**重要**: このバイナリファイル形式は JSON 形式よりも解析が困難で、内容が暗号化されているため、不正アクセスから保護されます。
