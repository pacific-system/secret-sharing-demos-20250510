# 準同型暗号マスキング方式（Method 8: Homomorphic Encryption Masking）

この方式は、同一の暗号文から異なる鍵を使用して異なる平文を復号できる「区別不能性」を持つ暗号化方式です。
暗号文や鍵に明示的なフラグは存在せず、外部からはどちらの平文が復号されるかを判別できません。

## 技術的原理

この方式は以下の技術的性質に基づいています：

1. **準同型特性**: 暗号文に対する特定の演算が平文に反映される性質を利用しています。例えば、E(a) ⊕ E(b) = E(a + b) という特性を持ちます。
2. **数学的に堅牢なマスク関数**: 単純なビット操作ではなく、準同型空間での線形/多項式変換を実装しています。
3. **鍵の識別不能性**: 鍵は数学的パラメータの差異によって内部的に区別されますが、外観上は区別できません。
4. **データ変換**: 2 つの異なるデータが同一の暗号文に変換されるように、差分マスクを適用します。

## 暗号化プロセス

最新の実装では以下のように動作します：

1. 2 つの平文データ（P_a, P_b）を用意します。
2. マスターシードから 2 つの鍵パラメータセット（K_a, K_b）を生成します。
   - これらは数学的に異なる線形関数 f(x) = (ax + b) mod n を定義します
   - 単純なハッシュ値の偶数/奇数性に依存しません
3. 各鍵からマスク（M_a, M_b）を導出します。
4. データセット A 用の暗号文を計算：C_a = P_a ⊕ M_a
5. データセット A 暗号文とデータセット B の差分を計算：P_b' = P_b ⊕ D
6. 最終暗号文 C = C_a を出力します。

これにより、同一の暗号文 C から、異なる鍵パラメータで異なる平文が復号されます。

## 復号プロセス

1. 暗号文 C と鍵 K を入力として受け取ります。
2. 鍵 K の数学的パラメータを解析します。
3. 鍵 K からマスク M を導出します。
4. マスクを除去して平文を取得します：P = C ⊖ M

## セキュリティ特性

この方式は以下のセキュリティ特性を持ちます：

1. **区別不能性**: 暗号文からは、その暗号文が本来どのデータを暗号化したものかを判別できません。
2. **鍵の識別不能性**: 鍵自体も外見上は区別がつかず、数学的パラメータの特性によってのみ区別されます。
3. **マスクの一方向性**: マスク生成は複雑な数学的変換を使用するため、マスクから鍵を逆算することは計算困難です。
4. **ソースコード開示耐性**: コード解析されても安全性が損なわれない堅牢な数学的方式を採用しています。

## 使い方

### 暗号化

```bash
python3 encrypt.py <ファイルA> <ファイルB> [--output <暗号化ファイル>] [--save-key]
```

### 復号

```bash
python3 decrypt.py <暗号化ファイル> --key <鍵ファイル> [--output <復号ファイル>] [--verbose]
```

## 実装例

1. 2 つのファイル（f.text, t.text）を暗号化します：

   ```bash
   python3 encrypt.py f.text t.text --save-key
   ```

2. 鍵 A を使って復号：

   ```bash
   python3 decrypt.py encrypted_TIMESTAMP_UUID.henc --key keys/dataset_a_key_TIMESTAMP_UUID.json --output decrypted_a.txt
   ```

3. 鍵 B を使って復号：
   ```bash
   python3 decrypt.py encrypted_TIMESTAMP_UUID.henc --key keys/dataset_b_key_TIMESTAMP_UUID.json --output decrypted_b.txt
   ```

## 応用例

1. **セキュアな情報共有**: 同一の暗号文から権限に応じて異なる情報を取得する仕組み
2. **データコントロール**: データ所有者は完全な情報を、他のユーザーには限定的な情報を提供
3. **信頼性の確保**: 盗聴や傍受があっても、どの情報が正確なものかを隠蔽できる
4. **防諜対策**: 意図的に「正規」鍵を漏洩させ、偽情報を信じ込ませる戦略が実装可能

## 主要な特徴

- **識別不能性（Indistinguishability）**: 暗号文からどちらのファイルが復号されるかを区別できません
- **準同型特性（Homomorphic Property）**: 暗号文に対する特定の演算が平文に反映される特性を活用
- **鍵による 2 通りの復号**: 同じ暗号文から 2 種類のファイルを復号可能
- **複数の形式対応**: テキスト、JSON、CSV、バイナリなど様々なデータ形式に対応
- **上書き防止**: UUID と日時スタンプを使用して出力ファイルの上書きを防止

## 注意事項

- どちらのキーが「正規」か「非正規」かはシステム上の区別ではなく、使用者の意図によって決まります
- 暗号化・復号には CPU やメモリリソースを消費するため、特に大きなファイルの処理には注意が必要です
- 特殊なバイナリフォーマットやサイズが大きく異なるファイルの組み合わせでは、完全な復号が困難な場合があります

## ライセンス

Copyright (c) 2025 暗号化方式研究
