# シャミア秘密分散法による複数平文復号システム設計書

## 5. セキュリティ分析

### 5.1. 攻撃モデルと脆弱性分析

以下の攻撃モデルを考慮する：

1. **パッシブ攻撃者**：

   - 暗号化ファイルを入手可能
   - ソースコードを完全に把握
   - 統計的・構造的分析を試みる

2. **アクティブ攻撃者**：
   - 上記に加え、不正なパスワードでの復号を多数試行可能
   - タイミング攻撃などのサイドチャネル攻撃を試みる可能性

主な脆弱性と対策：

| 脆弱性                 | 対策                                                                           |
| ---------------------- | ------------------------------------------------------------------------------ |
| シェア識別攻撃         | パーティション空間の混在分散配置、統計的区別不可能性の確保                     |
| ブルートフォース攻撃   | 強力な KDF の使用、十分な計算コスト設定                                        |
| タイミング攻撃         | 条件分岐の排除、一定時間での処理実行                                           |
| メタデータ分析         | メタデータの極小化（ソルト値のみ）、文書種別情報の排除                         |
| シェア数不足の問題     | 常に全てのシェアを使用し、不足のリスクを根本的に排除                           |
| チャンクサイズ分析攻撃 | 固定サイズ（64 バイト）チャンクの厳守、サイズの均一性維持                      |
| 復号不能攻撃           | 事前容量検証と全シェア位置に有効データ配置の厳守、ゴミデータの混入防止         |
| 部分復号による情報漏洩 | パディング適用によるデータサイズの正規化、全シェア位置が有効データで満たされる |

### 5.2. マップデータの安全性

マップデータの安全性は以下の要素に依存する：

1. **鍵導出関数の強度**：

   - Argon2 または PBKDF2 など、実績のある KDF を使用
   - 十分なイテレーション回数と計算コスト
   - **KDF 推奨パラメータ**：
     - Argon2id: メモリ 64MB、イテレーション 3 回、並列度 4
     - PBKDF2-HMAC-SHA256: イテレーション回数 310,000 回以上、出力キー長 32 バイト
     - これらのパラメータは、OWASP 推奨値および業界標準に基づく 2024 年時点での推奨値
     - 実装環境のハードウェア性能に応じて調整し、約 1 秒の処理時間を目安とする

2. **決定論的生成**：

   - 同一パスワードからは常に同一マップを生成
   - パスワードがわずかに異なれば、全く異なるマップを生成
   - パスワードの文字列長に依存しない処理を実現（ハッシュ化による固定長変換）

3. **予測不可能性**：
   - パスワードを知らなければマップ予測は計算量的に不可能
   - マップデータの部分的な漏洩が他の部分の予測に繋がらない

### 5.3. ソースコード漏洩時のセキュリティ

ケルクホフの原理に従い、ソースコード漏洩時でも以下の理由でセキュリティは保たれる：

1. **パスワード依存**：

   - セキュリティはパスワードの強度のみに依存
   - UTF-8 マッピングのあらゆる文字（漢字・絵文字含む）をサポートし、パスワードエントロピーを向上
   - ソースコードからはパスワードを導出不可能

2. **パーティション空間の隠蔽**：

   - パーティション空間の割り当ては外部から観測不可能
   - 統計的に区別不可能な設計

3. **多段 MAP 方式の有効性**：
   - アルゴリズムを完全に理解していても、パスワードとパーティションマップキーがなければ復号不可能
   - 固定サイズチャンク（64 バイト）とパディング適用により、実データとゴミデータの区別が不可能

### 5.4. 固定サイズチャンクの安全性意義

固定サイズチャンク（64 バイト）を厳格に適用する安全性上の意義：

1. **統計的区別不能性の保証**：

   - 全チャンクが同一サイズであることで、チャンクサイズに基づく統計的分析が無効化
   - AB の区分や実データ/ゴミデータの区別が統計的に不可能

2. **サイドチャネル攻撃の防止**：

   - 処理時間がデータ内容に依存しないため、タイミング分析による攻撃を防止
   - メモリアクセスパターンが均一化し、キャッシュタイミング攻撃への耐性向上

3. **容量情報の隠蔽**：

   - 実際のデータ量がチャンクサイズと数から判別不能
   - パディング適用により、元データのサイズ情報が漏洩しない

4. **堅牢な復号プロセス**：
   - 全シェア位置に有効データを配置することで、復号時の不確定性を排除
   - 常に同じ数のシェアを処理するため、シェア数による情報漏洩がない

### 5.5. 未割当領域のセキュリティ強化

未割当領域がもたらすセキュリティ強化：

1. **統計的攻撃の難化**：

   - 攻撃者がファイル全体の 20-40%を無視できない
   - パターン認識による攻撃が困難になる

2. **将来の拡張性確保**：

   - 将来的な機能追加のための余白として機能
   - セキュリティモデルを変更せずに拡張可能

3. **攪乱効果**：
   - ランダムなゴミデータが攻撃者の分析を妨害
   - 固定サイズチャンク（64 バイト）と組み合わせることで、有効データと無効データの区別を不可能にする

### 5.6. 全シェア使用のセキュリティ上の利点

本システムでは従来のシャミア秘密分散法で一般的な閾値の概念を使用せず、常に全てのシェアを使用する設計を採用しています。この設計には以下のセキュリティ上の利点があります：

1. **部分的なシェアの漏洩対策**：

   - 全てのシェアが揃わなければ復号できないため、一部のシェアが漏洩してもセキュリティは保たれる
   - 従来の閾値方式では、閾値以上のシェアが漏洩した場合に秘密情報が露出するリスクがある

2. **シェア選択攻撃の排除**：

   - 攻撃者が特定のシェア集合を選択的に収集することができない
   - 全てのシェアが必要なため、シェア選択による攻撃ベクトルが根本的に排除される

3. **実装の単純化とエラーリスクの低減**：

   - 閾値パラメータが不要になり、その設定ミスによるセキュリティリスクを排除
   - シェア数不足による復号失敗のリスクが回避され、システムの信頼性が向上

4. **数学的整合性の確保**：

   - 全シェア位置に有効データを配置することで、数学的に整合性のある多項式を確保
   - ゴミデータと有効データの混在による不確定な復号結果を防止

5. **セキュリティモデルの簡素化**：

   - 特定の閾値未満のシェア漏洩がもたらす情報量を考慮する必要がない
   - シェア漏洩のリスク評価が単純化され、「全てか無か」のモデルとなる

6. **シェア管理の一元化**：
   - 各シェアが等しく重要となり、特別な保護が必要なシェアが存在しない
   - シェア管理の複雑さが低減され、運用上のミスを防止
