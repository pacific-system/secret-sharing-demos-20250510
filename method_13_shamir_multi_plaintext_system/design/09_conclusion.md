# シャミア秘密分散法による複数平文復号システム設計書

## 9. 結論

本設計書では、シャミア秘密分散法を応用した複数平文復号システムの詳細設計を提供した。核心となる「パーティションマップキーによる MAP 生成とパスワードによるマップ生成」という多段 MAP 方式により、単一の暗号化ファイルから異なるパスワードで異なる平文を復号可能なシステムが実現できる。本システムでは従来のシャミア秘密分散法における閾値の概念を使用せず、常に全てのシェアを使用して復号を行う設計を採用することで、部分的なシェア漏洩に対する堅牢性と実装上の一貫性を確保している。さらに、バージョンの概念を完全に排除し、メタデータを極小化（ソルト値のみ）することで、より堅牢でシンプルな実装を実現している。また、パスワードとして UTF-8 マッピングのあらゆる文字（漢字・絵文字等を含む）をサポートし、直交処理原則に基づいて文字種や長さに関わらず常に同一の処理を適用している。

本システムの特徴的な設計要素として、固定サイズ（64 バイト）チャンクの厳格な適用と、全シェア位置への有効データ配置要件がある。これにより「AB の区分が不能」「ゴミとそれ以外の区分が不能」という堅牢性の原則を満たし、統計的区別不可能性を実現している。また、暗号化前の容量検証とパディング処理により、常に数学的に整合性のある多項式を確保し、復号処理の確実性を高めている。

全シェア使用方式を採用したことで、以下の重要な利点が得られる：

1. 部分的なシェアの漏洩が秘密情報を露出させるリスクを根本的に排除
2. 復号プロセスが単純化され、シェア選択による攻撃ベクトルが排除
3. 閾値設定のミスに起因するセキュリティリスクが発生しない
4. 全シェア位置に有効データを配置することで統計的区別不能性を強化

また、64 バイト固定サイズチャンクの厳格な適用により、以下のセキュリティと信頼性の向上が実現する：

1. チャンクサイズの統一によりサイドチャネル攻撃からの保護を強化
2. 固定サイズ処理によって実装の条件分岐を削減し、タイミング攻撃への耐性を向上
3. 完全に一貫した固定長処理によって復号プロセスの信頼性を確保
4. Base64 エンコード後の固定長シリアライズにより、あらゆる変動要因を排除
5. メタデータを極小化（ソルト値のみ）することで、情報漏洩リスクを最小化

本設計はケルクホフの原理に厳格に従い、アルゴリズムが完全に公開されてもパスワード（鍵）が秘匿されている限りセキュリティが保たれる。また、直線的処理や条件分岐の排除など、サイドチャネル攻撃に対する耐性も考慮されている。全シェアを使用する方式の採用により、シェア選択攻撃に対する耐性が強化されている点も本システムの特徴である。

実装に際しては、本設計書で提示したガイドラインや推奨データ構造、ライブラリを参考にすることで、安全かつ効率的なシステムを構築することが可能である。シェア ID 空間サイズとチャンクサイズに基づく容量制限は、`constants.py`に明示的に記載し、安全に運用できるよう配慮することが重要である。

過去に暗号化したファイルが開けない場合は、例外的な運用として、順番に過去の方式を試すことで対応する。これにより、バージョン情報をメタデータに含める必要がなくなり、より堅牢なセキュリティモデルを実現できる。この方針は「極力メタデータを少なくする」という設計原則に合致している。

さらに、本設計の重要な特徴として、整数値による明示的なファイルパーティション設計がある。`PARTITION_SIZE`、`ACTIVE_SHARES`、`GARBAGE_SHARES`、`UNASSIGNED_SHARES`といった値を整数で明示的に定義し、`SHARE_ID_SPACE`を自動計算することで、以下の重要な利点が得られる：

1. 完全な決定論的動作：小数点に起因する端数処理や丸め誤差がなく、常に確定的な動作を保証
2. パーティション設計の透明性：各ファイルが使用可能な容量が`ACTIVE_SHARES × CHUNK_SIZE`で明確に定義され、容量計画が容易
3. ファイル間の完全対称性：ファイル A/B に同一サイズのパーティションを割り当てることで、統計的攻撃への耐性を向上
4. 実装の堅牢性：整数値のみを使用することで、実装エラーのリスクを低減し、テスト容易性を向上
5. 定数時間処理の簡素化：固定パラメータにより、条件分岐を排除した定数時間処理の実装が容易

この設計思想により、システム全体がより安定し、予測可能な動作を示すとともに、セキュリティや実装の堅牢性が大幅に向上する。
