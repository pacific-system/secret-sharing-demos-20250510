# シャミア秘密分散法による複数平文復号システム設計書

## 6. 性能評価

### 6.1. ファイルサイズ評価

**暗号化後のファイルサイズの特性**：

- **重要**: 暗号化後のファイルサイズは元の JSON サイズに**依存しない**
- 暗号化後のファイルサイズは**`SHARE_ID_SPACE`（自動計算される整数値）のみ**によって決定される
- ファイルサイズは`USER_PARTITION_SIZE`、`USER_ACTIVE_SHARES`、`USER_GARBAGE_SHARES`、`UNASSIGNED_SHARES`の値に対して**完全に固定**である

**前処理による完全固定サイズ保証**：

- システムの前処理により、入力 JSON は完全に一貫した固定形式に変換される：
  - JSON 文字列の正規化（スペース除去、一貫した引用符使用）
  - 一貫したエンコーディング（UTF-8→ 圧縮 →Base64）
  - **Base64 エンコード後に固定長シリアライズ処理**:
    - エンコード済みデータを厳密な固定長ブロックに変換
    - 出力 JSON 内の各フィールド（シェア ID、値など）も固定長形式でシリアライズ
  - 固定サイズチャンク（64 バイト）への分割（システム全体で厳格に 64 バイト固定）
  - 必要に応じたパディング処理

この Base64 エンコード後の固定長シリアライズにより、シェア値の数値表現による差異も含め、**あらゆる変動要因を完全に排除**できます。したがって、同じユーザーパーティション設計を使用する場合、暗号化ファイルのサイズは常に完全に同一となります。

暗号化可能な JSON サイズの制限と固定ファイルサイズの関係：

| パーティション設計                                              | 自動計算される SHARE_ID_SPACE | 暗号化後のファイルサイズ | 暗号化可能な JSON 上限 |
| --------------------------------------------------------------- | ----------------------------- | ------------------------ | ---------------------- |
| USER_PARTITION_SIZE=1000, USER_ACTIVE_SHARES=600 (各ユーザー)   | 3000 (=1000×2+1000)           | 240KB 固定               | 約 38KB (=600×64B)     |
| USER_PARTITION_SIZE=3500, USER_ACTIVE_SHARES=2000 (各ユーザー)  | 10000 (=3500×2+3000)          | 800KB 固定               | 約 128KB (=2000×64B)   |
| USER_PARTITION_SIZE=10000, USER_ACTIVE_SHARES=6000 (各ユーザー) | 30000 (=10000×2+10000)        | 2.4MB 固定               | 約 384KB (=6000×64B)   |

**暗号化ファイルサイズが固定される理由**：

- `SHARE_ID_SPACE`（自動計算される整数値）が暗号化ファイルの基本サイズを決定
- 第 2 段階 MAP で確定した全シェア位置（`USER_ACTIVE_SHARES`個）に有効データを配置する設計
- 64 バイト固定サイズチャンクの使用（システム全体での一貫した固定値）
- Base64 エンコード後の完全固定長シリアライズ処理
- 統計的区別不能性を確保するための固定構造設計
- メタデータの極小化（ソルト値のみ）によるファイルサイズの一貫性確保

この完全固定サイズ特性により、暗号化ファイルからはオリジナルの JSON データ量が推測できないというセキュリティ上の利点があります。

### 6.2. 処理性能評価

**暗号化・復号処理の性能特性**：

- **暗号化処理時間**: シェア ID 空間サイズに比例

  - 低セキュリティ (1,000): 約 0.5 秒
  - 標準セキュリティ (10,000): 約 3-5 秒
  - 高セキュリティ (100,000): 約 30-40 秒

- **復号処理時間**: 選択シェア数と閾値に比例
  - 標準的な設定（シェア数 8-9）: 約 0.5-1 秒
  - これは元の暗号化に使用したシェア ID 空間サイズに依存しない

**メモリ使用量**：

- **暗号化時**: シェア ID 空間サイズに比例

  - 低セキュリティ (1,000): 約 20-30MB
  - 標準セキュリティ (10,000): 約 100-150MB
  - 高セキュリティ (100,000): 約 1-1.2GB

- **復号時**: 選択シェア数に比例
  - 標準的な設定（シェア数 8-9）: 約 10-20MB

**CPU リソース使用率**：

- マルチコア CPU の場合、自動的に並列計算を活用
- 単一コアでも効率的に動作するよう最適化済み
- KDF（鍵導出関数）の処理が最も CPU 負荷が高い

### 6.3. ストレージ要件

- 暗号化されたファイルサイズの予測が容易（シェア ID 空間サイズから確定的に計算可能）
- テンポラリファイル: 処理中に元のファイルサイズの約 2 倍の一時的なディスク容量を使用
- ログファイル: WAL ログは通常小さいが、頻繁な更新処理がある場合は監視が必要

### 6.4. 全シェア使用時の性能考慮

全シェアを常に使用する設計に関する性能上の考慮点：

| 考慮点               | 影響                                                 | 対策                                                       |
| -------------------- | ---------------------------------------------------- | ---------------------------------------------------------- |
| **処理時間**         | シェア数に比例して復号処理時間が増加                 | チャンク処理の並列化、効率的なラグランジュ補間実装         |
| **メモリ使用量**     | 全シェア処理による一時的なメモリ使用量増加           | ストリーミング処理の実装、メモリ効率の最適化               |
| **ディスク使用量**   | 閾値方式と比較して同等（初期生成時は全シェアが必要） | 効率的なシリアル化フォーマットの採用                       |
| **ネットワーク負荷** | データ転送量は変化なし（初期状態で全シェアが必要）   | データ圧縮、バイナリエンコーディングの最適化               |
| **スケーラビリティ** | 大量のシェア処理による性能低下の可能性               | シェア数の適切な設定（n=8 ～ 16 程度が実用的な上限と想定） |

### 6.5. 固定容量制限の影響

固定容量制限と固定サイズチャンクに関連する性能上の考慮点：

| 考慮点                         | 影響                                             | 対策                                                         |
| ------------------------------ | ------------------------------------------------ | ------------------------------------------------------------ |
| **容量超過確認オーバーヘッド** | 暗号化前の容量検証による余分な処理時間           | 効率的なチャンク数計算アルゴリズムの実装、早期判定の最適化   |
| **パディング処理コスト**       | 固定サイズ調整のためのパディング処理時間         | 効率的なパディングアルゴリズムの採用、バッファリングの最適化 |
| **シェア生成効率**             | 常に固定数のシェアを生成するためのオーバーヘッド | シェア生成の並列化、事前計算の活用                           |
| **ストレージ効率**             | 固定サイズ要件によるストレージ使用効率の低下     | 圧縮アルゴリズムの最適化、メタデータの最小化                 |
| **最大ファイルサイズ**         | シェア ID 空間サイズによる暗号化可能上限の制約   | 要件に応じたシェア ID 空間サイズの適切な設定                 |

### 6.6. シェア ID 空間サイズと暗号化可能サイズの関係

ユーザーパーティション設計が暗号化可能な JSON サイズに与える影響（概算値）：

| ユーザーパーティション設計                                      | 自動計算される SHARE_ID_SPACE | 暗号化可能な JSON 上限 | 圧縮率考慮時の理論上限         |
| --------------------------------------------------------------- | ----------------------------- | ---------------------- | ------------------------------ |
| USER_PARTITION_SIZE=1000, USER_ACTIVE_SHARES=600 (各ユーザー)   | 3000 (=1000×2+1000)           | 38KB (600×64B)         | 約 76-114KB（圧縮率による）    |
| USER_PARTITION_SIZE=3500, USER_ACTIVE_SHARES=2000 (各ユーザー)  | 10000 (=3500×2+3000)          | 128KB (2000×64B)       | 約 256-384KB（圧縮率による）   |
| USER_PARTITION_SIZE=10000, USER_ACTIVE_SHARES=6000 (各ユーザー) | 30000 (=10000×2+10000)        | 384KB (6000×64B)       | 約 768KB-1.1MB（圧縮率による） |

※計算基準: 固定チャンクサイズ 64 バイト、圧縮率約 50-70%を想定
※各ユーザー(A/B)は常に同一の`USER_ACTIVE_SHARES`値を持ち、同一の最大容量を利用可能
※暗号化可能な最大データ容量は`USER_ACTIVE_SHARES × CHUNK_SIZE`で直接計算される
