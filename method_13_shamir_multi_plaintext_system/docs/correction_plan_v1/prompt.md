# シャミア秘密分散法による複数平文復号システム修正プロンプト

## システム概要

シャミア秘密分散法を用いた複数平文復号システムは、単一の暗号化ファイルから異なるパスワードとパーティションキーを使用して異なる平文（JSON 文書）を復号できる技術です。このシステムは「パーティションマップキーによる MAP 生成とパスワードによるマップ生成」という多段 MAP 方式を核心としています。

## 現状の問題点

現在の実装には以下の問題点があります：

1. **パーティションキーの本来機能が未実装**: パーティションキーが各ユーザーの最大領域を正しく分離できていない
2. **MAP 生成ロジックの不整合**: 同じパーティションキーとパスワードでも異なる結果が生成され、復号が不安定
3. **更新処理の問題**: 複数ユーザー文書が共存する場合、更新によりデータが喪失する
4. **過大なシェア ID 空間サイズ**: 約 43 億のシェア ID 空間により、メモリ消費が過大でプロセスが強制終了
5. **暗号化ファイル形式の冗長性**: 不要なメタデータにより、ファイルサイズが増大

## 修正指示

以下の順序で修正を行ってください。各問題について具体的な修正指示を記載します。

### 1. パーティションキーの本来機能実装（最高優先度）

1. `shamir/partition.py`モジュールを新規作成し、以下の関数を実装：

   - `generate_partition_map(partition_key, share_id_space_size, required_shares)`: パーティションキーから決定論的に割り当てシェア ID 空間を生成
   - パーティションキーに基づくハッシュ値からシェア ID を生成する処理を実装

2. `core.py`の`stage1_map`関数を修正：

   - 既存の非確定的な実装を、新しい決定論的な実装に置き換え
   - 同じパーティションキーから常に同じシェア ID 群が生成されるようにする

3. キー管理機能を強化：
   - `key_management.py`の`PartitionKeyManager`クラスを改善し、正規化と一意性を確保
   - `keys.json`の形式を定義し、適切に読み書きする機能を実装

### 2. MAP 生成ロジックの不整合修正（高優先度）

1. `core.py`の`stage2_map`関数を修正：

   - パスワードとソルトから決定論的なスコア付けを行う処理に変更
   - ハッシュベースの一貫したスコア生成を実装

2. `crypto.py`の暗号化/復号処理を一貫性のある実装に変更：

   - 両方の関数で同じマップ生成ロジックを使用
   - 復号操作が暗号化操作と対称になるようにする

3. デバッグ関数を追加：
   - MAP 生成の検証用機能を実装（テスト用）

### 3. 更新処理の問題修正（高優先度）

1. `update.py`の更新処理を修正：

   - Write Ahead Logging (WAL)方式を実装して更新中のデータ安全性を確保
   - 複数のパーティションのシェアを適切に保持する処理を実装

2. メタデータ管理を改善：

   - 各パーティションのチャンク数を個別に管理するメタデータ構造を実装
   - `metadata.py`モジュールで一元管理

3. 更新操作でのシェア ID 競合回避：
   - パーティション間で同じシェア ID を使用する場合の競合解決処理を実装

### 4. シェア ID 空間サイズの最適化（中優先度）

1. `constants.py`のシェア ID 空間サイズを修正：

   - `SHARE_ID_SPACE`を 2^32-1 から 10000 程度に縮小
   - セキュリティレベルに応じた 3 段階のサイズ定義（低/標準/高）

2. メモリ効率のよい ID 生成機能を実装：

   - `share_id.py`モジュールを作成し、効率的な ID 生成関数を実装
   - 全 ID を一度にメモリに保持しない実装に変更

3. パフォーマンスモニタリング機能を追加：
   - メモリ使用量と実行時間を測定する機能の実装

### 5. 暗号化ファイル形式の最適化（中優先度）

1. 最適化されたファイル形式を設計：

   - `formats.py`モジュールを新規作成
   - シェア値のみを効率的に格納する構造に変更

2. 暗号化/復号処理を新形式に対応させる：

   - `crypto.py`の両関数を修正
   - 古い形式との後方互換性を維持

3. 変換ユーティリティの実装：
   - 古い形式から新しい形式への変換機能
   - CLI コマンドとして提供

### 6. テスト計画

以下のテストを実装し、すべての修正が正しく機能することを確認してください：

1. ユニットテスト：

   - 各修正に対応するテストを作成（例：`test_partition_key.py`）
   - エッジケースや境界条件のテスト

2. 統合テスト：

   - 複数のモジュールを組み合わせたテスト
   - CLI コマンドの動作確認

3. パフォーマンステスト：
   - メモリ使用量と CPU 時間の測定
   - 大規模データでのスケーラビリティ確認

## 実装における注意点

1. **決定論的動作**: 同じ入力からは常に同じ出力が生成されるようにする
2. **互換性**: 古いデータ形式にも対応する
3. **エラー処理**: エラーが発生しても適切に処理する
4. **ドキュメント**: コード内にドキュメントを記述し、関数の挙動を明確にする
5. **パフォーマンス**: メモリ使用量と実行時間を最適化する

## 成果物

修正完了後、以下の成果物を提出してください：

1. 修正されたすべてのソースコード
2. テストケースと結果報告
3. 修正内容の説明ドキュメント
4. パフォーマンス測定結果

この修正により、システムの信頼性、効率性、および安全性が大幅に向上することを期待します。
