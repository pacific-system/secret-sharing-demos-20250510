# シャミア秘密分散法による複数平文復号システム再設計

## 1. 用語体系と振る舞いの定義

### 1.1 基本用語

- 暗号書庫 = `CryptoStorage`
- 生成処理 = `createCryptoStorage`（現在の「初期化」に相当）
- 更新処理 = `updateCryptoStorage`
- 読取処理 = `readCryptoStorage`

### 1.2 システムパラメータ

- `ACTIVE_SHARES`：各ファイル(A/B)用の有効シェア数（整数、共通値）
- `GARBAGE_SHARES`：各ファイル(A/B)用のガベージシェア数（整数、共通値）
- `PARTITION_SIZE`：各ファイル(A/B)用パーティション総サイズ（ACTIVE_SHARES + GARBAGE_SHARES）
- `UNASSIGNED_SHARES`：未割当シェア数（整数）、AB どちらにも所属しないガベージシェア
- `SHARE_ID_SPACE`：全シェア ID 空間（PARTITION_SIZE \* 2 + UNASSIGNED_SHARES）

## 2. 処理フロー

### 2.1 暗号書庫の生成（createCryptoStorage）

- **目的**: 暗号書庫を初期状態で作成し、A/B 両領域の基盤構造を確立する
- **入力**: なし（システムパラメータのみ使用）
- **処理**:
  1. 全シェア空間にガベージシェアを配置し、統計的区別不可能性の基盤を確立
  2. 全シェア ID 空間（`SHARE_ID_SPACE`）をランダムに 3 区画に分割
     - A 用パーティション（`PARTITION_SIZE`分の ID 領域）
     - B 用パーティション（`PARTITION_SIZE`分の ID 領域）
     - 未割当領域（`UNASSIGNED_SHARES`分の ID 領域）
  3. 各パーティション分布がお互いに重複しないよう確保
  4. A 領域と B 領域に対応するパーティションマップキーを生成
     - 各パーティションマップキーは対応する領域の ID マッピングのみを復元可能
     - 逆変換によりマップキーから元の領域分布を再構築可能に設計
- **出力**:
  - 暗号書庫ファイル（全領域がガベージシェアで満たされた状態）
    - タイムスタンプを含まない UUID ベースのファイル名で生成される
    - これにより作成時期の情報が漏洩することを防止
  - A 用パーティションマップキー：A 用領域の分布を決定論的に特定するためのキー
  - B 用パーティションマップキー：B 用領域の分布を決定論的に特定するためのキー
- **特性**:
  - 暗号書庫生成時点では有効データは含まれず、後続の更新操作により有効データが書き込まれる
  - 生成されたパーティションマップキーはシステム上に保管されず、CLI で利用者に表示されるのみ
  - パーティションマップキーの安全な保管は利用者の責務であり、表示後システムは責務を負わない
  - A 領域と B 領域は完全分離：両領域は互いに不可侵で重複なし
  - 非決定論的分布：暗号書庫の生成ごとに異なるランダムな分布が生成される（セキュリティ向上のため）
  - パーティションマップキーの必要性：領域分布がランダムなため、特定のパーティションを再度アクセスするにはマップキーが必須

### 2.2 暗号書庫の更新（updateCryptoStorage）

- **目的**: パーティションマップキーが示す領域にデータを格納する
- **入力**:
  - 平文データ（UTF-8 エンコードされた JSON ファイル）
  - 対応するパーティションマップキー
  - 対応するパスワード
- **処理**:
  1. パーティションマップキーから第 1 段階 MAP を再生成
     - パーティションマップキーを用いて、対応する領域の ID 分布を再構築
     - この再構築により、`PARTITION_SIZE`分の ID 空間が確定される
  2. 第 1 段階 MAP とパスワードから第 2 段階 MAP を生成（`ACTIVE_SHARES`分の ID 選択）
     - パスワードからハッシュ値を生成
     - ハッシュ値と第 1 段階 MAP の ID 空間を使用して決定論的乱数を生成
     - 第 1 段階 MAP が定義する ID 空間内での絶対位置として`ACTIVE_SHARES`分の ID を決定論的に選択（`SHARE_ID_SPACE`に対しては暗号書庫が変わるごとに第 2 段階 MAP が示す有効なシェアの位置が変わる）
     - 選択された ID の集合が第 2 段階 MAP となる
     - 相対位置を使用することで同じパスワードでも異なるパーティションマップキーでは異なる絶対位置になり、セキュリティが向上する
  3. データフロー処理:
     1. 前処理と容量検証
        - JSON データのサイズが `ACTIVE_SHARES × CHUNK_SIZE` の容量制限内であることを検証
     2. 多段エンコードプロセスの適用
        - UTF-8 テキスト（元の JSON）
        - Latin-1 へのエンコード変換
        - Base64 エンコード
        - 固定長シリアライズ処理（入力データサイズに関わらず完全な固定サイズを保証）
     3. 平文データ → チャンク分割（64 バイト固定長、合計で正確に`ACTIVE_SHARES`個のチャンクを生成）
     4. 各チャンク → シャミア法適用 → `ACTIVE_SHARES`個のシェア生成（各チャンクが ACTIVE_SHARES 個のシェアに正確に変換される）
     5. ACTIVE_SHARES 個のシェア群を第 2 段階 MAP に配置しファイルに保存（暗号化状態）
- **出力**: 更新された暗号書庫ファイル
- **特性**:
  - 状態認識なし: 前の状態を考慮せず、指定された MAP に完全に上書き
  - 冪等性: 同一暗号書庫・同一パスワード・同一パーティションマップキーによる複数回の呼び出しは同一結果となる
  - 履歴無依存: 初回更新も 2 回目以降の更新も同一の処理パスをたどる
  - 決定論的: 同じパスワードと同じ第 1 段階 MAP からは常に同じシェア ID 集合が生成されるが、パーティションマップキーが異なれば SHARE_ID_SPACE に対しての絶対位置は異なる（第 1 段階 MAP に対して第 2 段階 MAP が分布するため）
  - 分離性: A 用と B 用のシェア空間は互いに重複せず、別のパーティションに属する
  - 固定サイズ変換: 入力データサイズに関わらず、多段エンコードと固定長シリアライズによって常に同一サイズのチャンク群に変換される
  - 統計的区別不可能性: 固定サイズ処理により、データサイズからファイル内容の特徴を推定できないよう保証

### 2.3 暗号書庫の読取（readCryptoStorage）

- **目的**: 第 2 段階 MAP が示す領域からデータを復号して取得する
- **入力**:
  - 対応するパーティションマップキー
  - 対応するパスワード
- **処理**:
  1. パーティションマップキーから第 1 段階 MAP を再生成
     - パーティションマップキーを用いて、対応する領域の ID 分布を再構築
     - この再構築により、`PARTITION_SIZE`分の ID 空間が確定される
  2. 第 1 段階 MAP とパスワードから第 2 段階 MAP を生成（`ACTIVE_SHARES`分の ID 特定）
     - パスワードからハッシュ値を生成
     - ハッシュ値と第 1 段階 MAP の ID 空間を使用して決定論的乱数を生成
     - 第 1 段階 MAP が定義する ID 空間内での相対位置として`ACTIVE_SHARES`分の ID を決定論的に選択
     - 選択された ID の集合が第 2 段階 MAP となる
     - 相対位置を使用することで同じパスワードでも異なるパーティションマップキーでは異なる絶対位置になり、セキュリティが向上する
  3. データフロー処理（復号過程）:
     1. シェア群取得 → 特定の MAP に基づくシェア選択
     2. 選択されたシェア → シャミア法逆適用 → チャンク復元
     3. チャンク結合 → 平文データ復元
- **出力**: 復号された UTF-8 エンコードの JSON ファイル（成功時）または無意味なデータ（失敗時）
- **特性**:
  - 検証なし: MAP の正当性検証や暗号書庫の整合性チェックは行わない
  - 決定論的: 同一パスワードと同一パーティションマップキーに対しては常に同一のシェア集合にアクセスするが、パーティションマップキーが異なれば絶対位置は異なる
  - 無条件実行: 指定された MAP に従い処理を実行し、結果の意味は呼び出し側が判断
  - 一方向性: MAP から元のパスワードやパーティションマップキーを逆算できない
  - 統計的区別不可能性: 生成された MAP から、どのシェアがどのファイルに属するか識別できない

## 3. ケルクホフの原理に基づく設計

本システムでは、第 2 段階 MAP にそのまま従い、その正当性を評価しません。これはケルクホフの原理に厳格に従い、システムのセキュリティがアルゴリズムの秘匿ではなくキー（パスワード）の秘匿のみに依存することを示します。

### 3.1 更新処理における許容事象

- 全く関連のない暗号書庫を、関連のないパスワードで上書きして破壊する
- 間違ったパスワードを使用して、異なる MAP で既存データを上書きする
- 同じ暗号書庫内で A のデータを B のデータで上書きする
- 空（未使用）の領域をデータで上書きする
- 既に使用済みの領域を新たなデータで上書きする

### 3.2 読取処理における許容事象

- 間違ったパスワードで読み取りを試み、無意味なデータを取得する
- 存在しないデータ領域の読み取りを試み、ガベージシェアを取得する
- A のパスワードを使って B のデータ領域にアクセスを試みる
- 一部破損した暗号書庫から部分的なデータを読み取ろうとする
- 異なるバージョンの暗号書庫を旧バージョンのアルゴリズムで読み取ろうとする

これらの事象は、暗号システムとしては正常な振る舞いであり、エラーや例外として扱うべきではありません。秘密はアルゴリズムではなく、適切なパスワードとパーティションマップキーの組み合わせにのみ依存します。
