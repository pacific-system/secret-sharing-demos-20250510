# シャミア秘密分散法による複数平文復号システム設計書

## 5. パフォーマンス考慮事項

### 5.1. パフォーマンス特性

本システムの主要なパフォーマンス特性は以下の通りです：

1. **計算負荷**：

   - シャミア秘密分散法の多項式演算が主要な計算負荷
   - パーティションマップキーの暗号化と復号における**全文そのままのパスワード（生のパスワード）**の処理

- 第 2 段階 MAP 生成における**必ず処理されたパスワード**の使用（**開発者は生のパスワードを誤って使用してはならない**）
  - パーティションマップキーを使用した固定長暗号化処理

2. **メモリ使用量**：

   - シェア生成と復元のための一時的なメモリ使用
   - ファイルサイズはほぼ一定の比率で拡大（元データの約 N 倍、N は `ACTIVE_SHARES` に依存）

3. **ストレージ効率**：

   - 統計的区別不可能性を確保するための冗長性があり、理論上のストレージ効率は元データの 1/`ACTIVE_SHARES`
   - 実際には A/B 両方の文書を格納するため、約 2/`ACTIVE_SHARES` の効率

4. **スケーラビリティ**：
   - JSON データの総サイズに制限があり、大規模データには適さない
   - 小〜中規模の秘密情報（パスワード、API キー、構成ファイルなど）に最適化

### 5.2. 実行時間分析

各主要関数の実行時間特性は以下の通りです：

#### 5.2.1. createCryptoStorage

```
T(createCryptoStorage) = O(TOTAL_SHARES) + T(encrypt_partition_map) * 2
```

- 全シェア空間の初期化が主要コスト
- パーティションマップキーの処理は定数時間（**全文そのままのパスワード（生のパスワード）**を使用）

#### 5.2.2. updateCryptoStorage

```
T(updateCryptoStorage) = O(json_size) + T(decrypt_partition_map) + T(multi_stage_encode) + O(ACTIVE_SHARES^2)
```

- JSON サイズに比例する処理時間
- シャミア法のシェア生成は O(ACTIVE_SHARES^2)
- パーティションマップキーの復号は**全文そのままのパスワード（生のパスワード）**を使用
- 多段エンコード処理にはパーティションマップキーを使用した固定長暗号化が含まれる

#### 5.2.3. readCryptoStorage

```
T(readCryptoStorage) = T(decrypt_partition_map) + O(ACTIVE_SHARES^2) + T(multi_stage_decode)
```

- シャミア法のラグランジュ補間は O(ACTIVE_SHARES^2)
- パーティションマップキーの復号は**全文そのままのパスワード（生のパスワード）**を使用
- 多段デコード処理にはパーティションマップキーを使用した固定長暗号化の解除が含まれる

### 5.3. 最適化戦略

#### 5.3.1. 計算最適化

1. **シャミア法の効率化**：

   - ガロア体上の演算にビットマスクとルックアップテーブルを使用
   - ラグランジュ係数の事前計算とキャッシング

2. **パスワード処理の最適化**：

   - パーティションマップキーの暗号化/復号（**全文そのままのパスワード（生のパスワード）**使用）と第 2 段階 MAP 生成（**必ず処理されたパスワード**使用）のバランス調整
   - パスワード処理結果のセッション内キャッシング

3. **並列処理**：

   - チャンク処理の並列化
   - マルチコア環境での性能向上

4. **固定長暗号化の最適化**：
   - パーティションマップキーを使用した効率的な暗号化アルゴリズムの選択
   - ブロック暗号の最適なモード選択

#### 5.3.2. メモリ最適化

1. **メモリ管理**：

   - 大きな一時配列の再利用
   - インプレース操作の採用

2. **バッファ戦略**：

   - 固定サイズバッファの使用
   - 動的メモリ割り当ての最小化

3. **機密データの保護**：
   - 使用後の機密データの明示的なメモリ消去
   - スワップファイルへの書き込み防止

#### 5.3.3. I/O 最適化

1. **ファイルアクセス**：

   - メモリマップトファイル使用の検討
   - バッファ付き I/O の活用

2. **WAL 処理**：

   - 効率的なバックアップ作成
   - 適切なディスクシンク戦略

3. **ファイルハンドリング**：
   - ファイルロックの最適化
   - 一時ファイルの効率的な管理

### 5.4. リソース使用量の目標

本システムの標準的な構成での目標リソース使用量は以下の通りです：

#### 5.4.1. メモリ使用量

| 操作                | ピークメモリ使用量 | 備考                                   |
| ------------------- | ------------------ | -------------------------------------- |
| createCryptoStorage | 〜10MB             | TOTAL_SHARES に比例                    |
| updateCryptoStorage | 〜20MB             | JSON サイズと ACTIVE_SHARES に依存     |
| readCryptoStorage   | 〜15MB             | ACTIVE_SHARES と復元データサイズに依存 |

#### 5.4.2. 処理速度

| 操作                | 1KB JSON の処理時間 | 10KB JSON の処理時間 | 備考                              |
| ------------------- | ------------------- | -------------------- | --------------------------------- |
| createCryptoStorage | 〜100ms             | 〜100ms              | JSON サイズに依存しない           |
| updateCryptoStorage | 〜150ms             | 〜250ms              | JSON サイズとパスワード処理に依存 |
| readCryptoStorage   | 〜120ms             | 〜200ms              | JSON サイズとパスワード処理に依存 |

#### 5.4.3. ストレージ使用量

| JSON サイズ | 暗号化ファイルサイズ | 備考                   |
| ----------- | -------------------- | ---------------------- |
| 1KB         | 〜16KB               | ACTIVE_SHARES=8 の場合 |
| 10KB        | 〜160KB              | ACTIVE_SHARES=8 の場合 |
| 100KB       | 〜1.6MB              | ACTIVE_SHARES=8 の場合 |

### 5.5. パフォーマンス計測とプロファイリング

本システムのパフォーマンスを測定するための方法と対象：

1. **計測対象**：

   - 各主要関数の実行時間
   - メモリ使用量のピークと平均
   - ディスク I/O 量
   - CPU 使用率

2. **プロファイリングポイント**：

   - シャミア秘密分散処理（シェア生成とラグランジュ補間）
   - パーティションマップキーの暗号化/復号（**全文そのままのパスワード（生のパスワード）**使用）
   - 第 2 段階 MAP 生成（**必ず処理されたパスワード**使用）（**開発者は生のパスワードを誤って使用してはならない**）
   - 多段エンコード/デコード処理（パーティションマップキーを使用した固定長暗号化を含む）
   - 暗号書庫のファイル I/O 操作

3. **ベンチマーク条件**：
   - 様々なサイズの JSON データ（1KB〜100KB）
   - 異なる ACTIVE_SHARES 値（4, 8, 16）
   - 様々な長さと複雑さのパスワード

### 5.6. 高速化と性能トレードオフ

実装において考慮すべき性能とセキュリティのトレードオフ：

1. **KDF 反復回数**：

   - 高い反復回数は安全性を高めるが処理時間が増加
   - 推奨: ユーザー環境に応じて調整可能にし、デフォルトは中〜高レベルの安全性を確保

2. **ACTIVE_SHARES と PARTITION_SIZE**：

   - 値を大きくするとセキュリティは向上するがパフォーマンスが低下
   - 推奨: ACTIVE_SHARES=8、PARTITION_SIZE=24〜32 をデフォルト値として提供

3. **並列処理の程度**：

   - 並列度を上げるとパフォーマンスは向上するがリソース消費が増加
   - 推奨: 利用可能な CPU コア数の 75% を使用するよう自動調整

4. **パスワード処理**：

   - パーティションマップキーの暗号化/復号には**全文そのままのパスワード（生のパスワード）**を使用
   - 第 2 段階 MAP 生成には**必ず処理されたパスワード**を使用（**開発者は生のパスワードを誤って使用してはならない**）
   - このバランスにより、セキュリティとパフォーマンスの両立を図る

5. **固定長暗号化**：
   - パーティションマップキーを使用した暗号化は安全性を高めるが処理時間が増加
   - 推奨: 効率的なブロック暗号モードを選択し、最適化を図る

### 5.7. パフォーマンス推奨事項

実運用環境でのパフォーマンス最適化のための推奨事項：

1. **ハードウェア要件**：

   - 最小: 2 コア CPU、4GB RAM、SSD ストレージ
   - 推奨: 4 コア以上の CPU、8GB 以上の RAM、NVMe SSD

2. **JSON サイズ制限**：

   - 実用的な上限は約 100KB
   - より大きなデータはチャンク分割して複数の暗号書庫に保存することを検討

3. **設定パラメータ調整**：

   - 高性能環境: ACTIVE_SHARES=16、PARTITION_SIZE=48
   - 標準環境: ACTIVE_SHARES=8、PARTITION_SIZE=32
   - 制約環境: ACTIVE_SHARES=4、PARTITION_SIZE=16

4. **動作モード**：
   - 通常モード: バランスの取れたセキュリティと性能
   - 高速モード: KDF 反復回数を減らし、並列度を最大化
   - 高セキュリティモード: KDF 反復回数を増やし、パーティションサイズを大きく
