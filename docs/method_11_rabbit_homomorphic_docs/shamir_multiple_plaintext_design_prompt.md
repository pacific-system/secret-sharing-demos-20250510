# シャミア秘密分散法による複数平文復号システム設計書生成プロンプト

## プロンプトの目的

このプロンプトは、AI モデルに対して「シャミア秘密分散法を応用した複数平文復号システム」の詳細な設計書を生成するよう指示するためのものです。単一の暗号化ファイルから、異なるパスワードを使用して異なる平文を復号できるシステムの設計を依頼します。このシステムの核心は「パスワードから生成されるマップデータによるシェア識別」という特有の仕組みにあります。このプロンプトに従って、AI が暗号理論に基づく専門的な設計書を作成することを期待しています。

## 生成物の提出要件

1. **提出形式**:

   - Markdown (.md) 形式で設計書を生成すること
   - `/Users/macbook/shamir-secret-sharing-demo/docs/method_11_rabbit_homomorphic_docs` ディレクトリに保存すること
   - ファイル名は `shamir_multiple_plaintext_design_YYYYMMDD.md` の形式とし、YYYYMMDD は作成日を表すこと（例: 20240517）

2. **構成要件**:
   - 見出しと階層構造を明確にすること
   - 図表を適宜使用し、理解を助けること
   - コード例は適切な言語のシンタックスハイライトを使用すること

## AI モデルの応答スタイル

このプロンプトへの回答では、以下の専門知識と経験を持つ暗号システム設計者としての立場で設計書を生成してください：

1. **専門分野**：

   - 暗号理論と実装（特に閾値暗号、秘密分散法）
   - セキュアコーディング
   - データ構造と効率的なアルゴリズム設計

2. **技術スキル**：

   - シャミア秘密分散法の理論と実装経験
   - 鍵導出関数（KDF）の適用知識
   - 統計的区別不可能性の設計手法
   - 大規模データ処理の最適化技術

3. **視点と思考法**：

   - セキュリティとユーザビリティのバランスを重視
   - エッジケースを網羅的に考慮できる
   - 数学的厳密さと実用性を両立させる思考
   - 攻撃者の視点からシステムを分析できる

4. **コミュニケーションスタイル**：
   - 技術的に正確かつ明瞭
   - 複雑な概念を図表や例を用いて説明
   - 実装上の注意点を具体的に指摘
   - トレードオフを明示的に示す

## 生成する設計書の品質要件

1. **事実に基づく情報**:

   - 推測や創作ではなく、検証可能な事実に基づいた設計を提供すること
   - 未検証の手法や理論的に証明されていない仮説は明示的に区別すること
   - 実装が不確かな部分は率直に示し、代替案を提案すること

2. **情報源の活用**:

   - Web 検索を活用し、シャミア秘密分散法の既存実装を調査すること
   - GitHub 等のオープンソースリポジトリから実装例を参照すること
   - 学術論文や技術文書から最新の研究成果を取り入れること
   - 暗号コミュニティの議論やベストプラクティスを反映すること

3. **出典と引用**:
   - 設計に使用した全ての情報源（リポジトリ、論文、技術記事など）を明示すること
   - 生成する設計書の最後に出典元のリンク集を含めること
   - 直接引用や参照した実装コードの出典を明記すること
   - 特許や著作権で保護された技術の使用に関する注意点を示すこと

## 設計すべきシステムの要件定義

### 基本アーキテクチャ

1. **複数平文の格納**：1 つの暗号化ファイルに 2 つの異なる JSON 文書（UTF-8）を格納
2. **パスワード依存**：各 JSON 文書に固有のパスワードを設定可能
3. **マップデータ生成**：パスワードから有効なマップデータを生成し（暗号化ごとに異なるマップが生成可能）、それを用いて関連するシェアを特定
4. **無差別処理**：復号処理は両文書で完全に同一の経路・プロセスを通る
5. **メタデータ不在**：シェア自体には所属する文書の種類を示すメタデータは含まない
6. **直線的処理**：復号処理は「パスワード入力 → マップ生成 → シェア選択 → 復号 → 結果返却」と評価や分岐なしに直線的に進行すること

### 絶対的セキュリティ要件

1. **評価分岐の排除**：復号処理中に「マップが正当か」「復号結果が有効か」などの評価による分岐を一切設けないこと
2. **例外処理なし**：不正なパスワードで生成されたマップでも、そのまま処理を継続し、結果をそのまま返却すること（メモリエラーやタイムアウトなどの外部要因による障害は別の責務とする）
3. **直線的フロー**：パスワード入力 → マップ生成 → 復号 → 結果返却の流れを厳格に守り、途中にチェックポイントを設けないこと
4. **同一経路処理**：どのようなパスワードに対しても完全に同一の経路を通り、入力されたパスワードからマップを生成し、そのマップに従って復号を試み、その結果を無条件で返却する単純な流れを維持すること

### セキュリティ要件

1. **混在シェア**：文書 A、文書 B、およびゴミデータのシェアが暗号化ファイル内に混在（ゴミシェアは全体の 30%）
2. **プロセス同一性**：復号処理は文書の種類によって分岐せず、同一のコードパスを通る
3. **ソースコード耐性**：ソースコードが攻撃者に漏洩しても、正しいパスワードなしには復号不可能
4. **マップデータ安全性**：パスワードからマップデータへの変換は、数学的に同じ文字数の文字列に正規化し、予測困難であること
5. **攻撃者モデル**：ソースコードを押収し、論理的に解読を試みる攻撃者を想定
6. **シェア同一性**：閾値を満たす任意のシェアの組み合わせ（例：ABC でも CDE でも）で同じ平文が復元できること

### 技術仕様

1. **暗号化対象**：UTF-8 エンコードされた JSON 文書（2 種類まで）
2. **シャミア秘密分散**：適切な閾値とシェア数の設定による秘密分散（閾値個のシェアで復号可能）
3. **マップ生成**：パスワードから安全な鍵導出関数（KDF）を用いて直接マップデータを生成（外部データ不要）
4. **シェア識別**：マップデータを使用して関連するシェアのみを特定・復号（シェア側には関連性を持たせない）
5. **ゴミデータ**：有効なシェアと区別できないランダムなゴミシェア（全体の 30%）の生成・混入
6. **不正パスワード**：不正なパスワードが入力された場合でも評価せず処理を継続し、生成されたマップに基づいて復号を試み、結果をそのまま返却する
7. **無条件処理**：復号処理中に if 文や try-catch などによる条件分岐を可能な限り排除し、同一経路での処理を保証すること

### 評価指標

以下のサイズの JSON ファイルに対する性能評価を設計書に含めること：

1. 10KB JSON を暗号化した場合の最終ファイルサイズ
2. 100KB JSON を暗号化した場合の最終ファイルサイズ
3. 1MB JSON を暗号化した場合の最終ファイルサイズ

## 設計書で扱うべき技術的課題と考慮点

### シャミア秘密分散法の設計

1. **多項式次数の最適化**：秘密分散における多項式の次数と必要シェア数の関係
2. **閾値設定**：復号に必要なシェア数（閾値）の適切な設定
3. **シェア分散戦略**：有効シェア 70%とゴミシェア 30%の最適な混在方法と配置
4. **シェア同等性**：任意の閾値個のシェアで同等に復号可能なシステムの設計（このシステムの核心部分）

### マップデータ設計

1. **パスワード正規化**：異なる長さのパスワードからの一貫したマップデータ生成
2. **鍵導出関数**：安全な KDF（PBKDF2, Argon2, scrypt など）の選定と設定
3. **マップデータフォーマット**：シェア識別に適した効率的なデータ構造（シェア側には関連性を持たせない設計）
4. **決定論的生成**：パスワードから直接かつ安全にマップデータを導出する方法
5. **無検証処理**：マップの正当性を検証せずに処理を継続するための設計

### セキュリティ設計

1. **区別不可能性**：文書 A、文書 B、ゴミデータのシェアが統計的・構造的に区別不可能であること
2. **マップデータの保護**：マップデータ生成アルゴリズムの秘匿性確保
3. **パスワード強度**：推奨パスワード強度とエントロピー要件
4. **ソースコード解析耐性**：ソースコードを入手した攻撃者による論理的解読への耐性
5. **タイミング攻撃耐性**：条件分岐がないことによるタイミング攻撃への耐性強化

### 実装上の課題

1. **効率的な復号**：マップデータを用いた効率的なシェア識別と再構築アルゴリズム（復号に 1 分程度の時間は許容）
2. **エラー処理の排除**：エラー発生時でも処理を中断せず、常に何らかの結果を返却する設計（外部要因によるエラーは別の責務として切り分ける）
3. **メモリ効率**：大きな JSON ファイル処理時のメモリ効率は性能に応じて調整可能（2 次的な処理機構に責務を委譲）
4. **条件分岐のない実装**：if 文や try-catch などを使わない代替実装パターン（パスワード入力 → マップ生成 → 復号 → 結果返却の直線的処理）

## 生成すべき設計書の内容・構成

1. **詳細設計書**

   - アルゴリズムの詳細説明
   - データフローと処理フロー図
   - シェア構造とマップデータ構造の定義
   - 「パスワードから生成されるマップデータによるシェア識別」という本設計特有の仕組みの詳細

2. **セキュリティ分析**

   - 攻撃モデルと脆弱性分析
   - マップデータの安全性証明
   - ソースコード漏洩時のセキュリティ保証
   - 復号処理の完全な同一経路保証の証明

3. **性能評価**

   - 各サイズの JSON に対する暗号化後ファイルサイズの予測
   - 暗号化/復号処理の計算量と時間複雑性
   - メモリ使用量の評価

4. **実装ガイドライン**

   - 推奨データ構造とアルゴリズム
   - 実績のある暗号ライブラリの活用方法
   - パフォーマンス最適化のためのベストプラクティス
   - 条件分岐を避けるコーディングパターン例

5. **参考資料と出典**
   - 調査に使用した学術論文のリスト
   - 参照したオープンソースプロジェクトへのリンク
   - 技術記事や仕様書の出典
   - 実装例の元となったコードリポジトリ

## 制約条件

設計書を作成する際は、以下の制約条件を遵守すること：

1. サイドチャネル攻撃対策は検討範囲外
2. 復号処理は文書の種類による分岐を含まないこと
3. シェア自体からは所属文書が判別不可能な設計であること
4. 外部データ（ユーザー指定 JSON など）に依存せず、パスワードのみで復号可能であること
5. 将来的に 3 つ以上の文書への対応は不要
6. 復号処理において、マップの正当性や復号結果の有効性を評価する分岐を一切設けないこと
7. 理論的に確かな設計を提供し、推測に基づいた設計は避けること
