# シャミア秘密分散法による複数平文復号システム設計書

## 0. 用語集

本設計書で使用される重要な用語と概念の定義を以下に示す：

### 0.1. 基本用語

| 用語                   | 定義                                                                                                                                                                          |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **シャミア秘密分散法** | Adi Shamir が考案した暗号技術。秘密情報を複数の「シェア」に分散し、全てのシェアが集まった場合のみ元の情報を復元できる仕組み。本システムでは全シェアを常に使用する実装を採用。 |
| **シェア（share）**    | シャミア秘密分散法によって生成される、秘密情報の断片。各シェアは（ID, 値）のペアで構成される。                                                                                |
| **チャンク（chunk）**  | 暗号化する前のデータを固定長の小さな断片に分割したもの。各チャンクに対してシャミア秘密分散法を適用する。本システムでは常に 64 バイト固定サイズを使用。                        |
| **パーティション空間** | システム内で使用されるシェア ID の全体集合。ファイル A 用、ファイル B 用、未割当ての 3 種類に分割される。初期化時に指定の集合が完成し以降集合の大きさが変わることない。       |
| **MAP（マップ）**      | 混在するシェア群の中から、必要なシェア全てを特定するための対応表または関数。特定の文書を復号する際に必要なシェアを一括して選別するために使用される。                          |

### 0.2. 本システム特有の用語

| 用語                         | 定義                                                                                                                                                                                                                        |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **パーティションマップキー** | ユーザーが保持する文字列で、特定の範囲のシェア ID を特定するためのキー。例：「A 用パーティションマップキー」で「A 用シェア」の ID セットを特定できる。単なる ID の集合ではなく、ID を特定するための元データとして機能する。 |
| **多段 MAP 方式**            | 本システムの核心技術。パーティションマップキーによる第 1 段階 MAP とパスワードによる第 2 段階 MAP を組み合わせて、必要なシェアを特定する方式。                                                                              |
| **第 1 段階 MAP**            | パーティションマップキーから生成される MAP。全シェア空間から復号に必要な候補シェア全てを特定する。                                                                                                                          |
| **第 2 段階 MAP**            | パスワードから生成される MAP。第 1 段階で特定された候補シェアの中から、実際に復号に使用するシェア全てを選別する。                                                                                                           |
| **統計的区別不可能性**       | 暗号ファイル内の異なる文書（A/B）のシェアや未割当領域のシェアが統計的に区別できない性質。外部観察者がどのシェアがどの文書に属するか識別できないことを保証する。                                                             |
| **直交処理原則**             | 全ての処理ステップが互いに独立して一貫性を持ち、入力データの特性に左右されず、常に同一の方法で実行されることを保証する原則。入力サイズや内容に関わらず処理が同一であることで、サイドチャネル攻撃への耐性を提供する。        |
| **直線的処理**               | 復号処理の途中で条件分岐や評価を含まず、同一のコードパスを通り抜ける処理方式。タイミング攻撃やサイドチャネル攻撃への耐性を持つ。直交処理原則を実現するための実装手法の一つ。                                                |
| **全シェア使用方式**         | 従来のシャミア秘密分散法で一般的な「閾値方式」（n 個中 k 個のシェアで復元可能）とは異なり、本システムでは常に指定されたシェア全てを使用して復号する方式。これにより部分的なシェア漏洩への耐性が強化される。                 |
| **パスワード処理**           | あらゆる UTF-8 文字（漢字・絵文字等を含む）をサポートし、ハッシュ化して固定長に変換することで、文字セットや長さに依存しない一貫した処理を実現。入力に関わらず常に同一の処理パイプラインで扱われる。                         |

### 0.3. データ構造と実装関連用語

| 用語                           | 定義                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **ファイルパーティション設計** | システム全体の基盤となる整数値による明示的な設計。以下の値が`constants.py`で定義される：<br>- `PARTITION_SIZE`：各ファイル(A/B)用パーティション総サイズ（整数、共通値）<br>- `ACTIVE_SHARES`：各ファイル(A/B)用有効シェア数（整数、共通値）<br>- `GARBAGE_SHARES`：各ファイル(A/B)用ゴミデータ数（整数、共通値）<br>- `UNASSIGNED_SHARES`：未割当シェア数（整数）、AB どちらにも所属しないゴミデータ<br>これらにより`SHARE_ID_SPACE = PARTITION_SIZE * 2 + UNASSIGNED_SHARES`が自動計算される。この設計は常に整数値で定義され、ファイル A/B に完全な対称性を持たせる。                                                                                                                                                                                                                                                                                       |
| **メタデータ**                 | 暗号化ファイルに保存される最小限の構成情報。このシステムではメタデータを極力少なくし、以下の情報のみを含む：<br>1. ソルト値（salt）：シェア生成に使用したソルト値<br><br>初期化時と暗号化・更新時で、このメタデータに変化は生じない。これにより、初期化ファイルと暗号化済みファイルが外部から区別できないようになっている。<br><br>以下のメタデータは情報漏洩リスクのため意図的に除外されている：<br>- **magic**：固定値はファイルの特性を示す手がかりになるため除外<br>- **created_at**：作成時刻の情報漏洩リスクがあるため除外<br>- **share_id_space**：配列の長さから計算可能なため冗長<br>- **total_chunks**：多段 MAP から導出可能なため冗長<br>- **threshold**：本システムでは閾値の概念は使用せず、常に全シェアを使用<br>- **file_type**：ファイル種別はパーティションキーから導出可能なため不要<br>- **version**：互換性は別の方法で処理するため不要 |
| **有効シェア**                 | `ACTIVE_SHARES`により定義される、各ファイル（A/B）が実際に暗号データを格納できるシェア。最大データ容量は`ACTIVE_SHARES × CHUNK_SIZE`で計算され、常に整数値で明示的に定義される固定容量となる。各ファイルは同一数の有効シェアを持ち、完全な対称性が保証される。パスワードと第 2 段階 MAP により、パーティション内のどのシェアが有効シェアとして使用されるかが決定される。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ガベージシェア**             | 未割当領域に配置される無意味なデータ。有効なシェアと統計的に区別できない形式で生成され、セキュリティ強化と将来の拡張性確保に役立つ。初期化時に全てのシェア空間がガベージシェアで埋められ、暗号化時にのみ必要な部分が有効なシェアに置き換えられる。`GARBAGE_SHARES`により定義される各ファイルパーティション内のゴミデータ数も同様に処理される。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **一時ファイル**               | 更新処理中に使用される中間ファイル。シャミア秘密分散法で暗号化され、処理完了時に削除される。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **固定サイズチャンク**         | 本システムの核心的な設計要素。データを常に同じサイズ（64 バイト）に分割して処理することで、統計的区別不可能性を確保し、サイドチャネル攻撃に対する耐性を高める。全てのチャンクは厳密に同一サイズで処理される。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **完全固定長シリアライズ**     | Base64 エンコード後のデータを固定長形式に変換する処理。シェア ID やシェア値などすべての要素を厳密に固定長でシリアライズし、ファイルサイズの一貫性と統計的区別不能性を確保する。データ量に関わらず常に同一のシリアライズ処理を適用する。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
