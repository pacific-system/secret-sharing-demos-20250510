# シャミア秘密分散法による複数平文復号システム設計書生成プロンプト

## プロンプトの目的

このプロンプトは、AI モデルに対して「シャミア秘密分散法を応用した複数平文復号システム」の詳細な設計書を生成するよう指示するためのものです。単一の暗号化ファイルから、異なるパスワードを使用して異なる平文を復号できるシステムの設計を依頼します。このシステムの核心は「シェア ID による可能性の限定とパスワードから生成されるマップデータによるシェア識別」という特有の多段 MAP 方式にあります。

本設計はケルクホフの原理（セキュリティはアルゴリズムの秘匿性ではなく、鍵の秘匿性に依存すべき）に厳格に従うものとし、システムのソースコードや仕組みが完全に公開されても、パスワード（鍵）が秘匿されている限りセキュリティが保たれる設計を目指します。このプロンプトに従って、AI が暗号理論に基づく専門的な設計書を作成することを期待しています。

## 生成物の提出要件

1. **提出形式**:

   - Markdown (.md) 形式で設計書を生成すること
   - `/Users/macbook/shamir-secret-sharing-demo/docs/method_11_rabbit_homomorphic_docs` ディレクトリに保存すること
   - ファイル名は `shamir_multiple_plaintext_design_YYYYMMDD.md` の形式とし、YYYYMMDD は作成日を表すこと（例: 20240520）

2. **構成要件**:
   - 見出しと階層構造を明確にすること
   - 図表を適宜使用し、理解を助けること
   - コード例は適切な言語のシンタックスハイライトを使用すること

## AI モデルの応答スタイル

このプロンプトへの回答では、以下の専門知識と経験を持つ暗号システム設計者としての立場で設計書を生成してください：

1. **専門分野**：

   - 暗号理論と実装（特に閾値暗号、秘密分散法）
   - セキュアコーディング
   - データ構造と効率的なアルゴリズム設計
   - ケルクホフの原理に基づく暗号システム設計

2. **技術スキル**：

   - シャミア秘密分散法の理論と実装経験
   - 鍵導出関数（KDF）の適用知識
   - 統計的区別不可能性の設計手法
   - 大規模データ処理の最適化技術

3. **視点と思考法**：

   - セキュリティとユーザビリティのバランスを重視
   - エッジケースを特定し、重要なものは解決策を提示、複雑なものは別の処理機構に委譲できることを明示
   - 数学的厳密さと実用性を両立させる思考
   - 攻撃者の視点からシステムを分析できる

4. **コミュニケーションスタイル**：
   - 技術的に正確かつ明瞭
   - 複雑な概念を図表や例を用いて説明
   - 実装上の注意点を具体的に指摘
   - トレードオフを明示的に示す

## 生成する設計書の品質要件

1. **事実に基づく情報**:

   - 推測や創作ではなく、検証可能な事実に基づいた設計を提供すること
   - 未検証の手法や理論的に証明されていない仮説は明示的に区別すること
   - 実装が不確かな部分は率直に示し、代替案を提案すること

2. **情報源の活用**:

   - Web 検索を活用し、シャミア秘密分散法の既存実装を調査すること
   - GitHub 等のオープンソースリポジトリから実装例を参照すること
   - 学術論文や技術文書から最新の研究成果を取り入れること
   - 暗号コミュニティの議論やベストプラクティスを反映すること

3. **出典と引用**:
   - 設計に使用した全ての情報源（リポジトリ、論文、技術記事など）を明示すること
   - 生成する設計書の最後に出典元のリンク集を含めること
   - 直接引用や参照した実装コードの出典を明記すること
   - 特許や著作権で保護された技術の使用に関する注意点を示すこと

## 設計すべきシステムの要件定義

### 基本アーキテクチャ

1. **複数平文の格納**：1 つの暗号化ファイルに 2 つの異なる JSON 文書（UTF-8）を格納
2. **パスワード依存**：各 JSON 文書に固有のパスワードを設定可能
3. **多段 MAP 方式**：シェア ID で可能性の範囲を限定した上で、パスワードから有効なマップデータを生成し、それを用いて関連するシェアを特定
4. **無差別処理**：復号処理は両文書で完全に同一の経路・プロセスを通る
5. **メタデータ不在**：シェア自体には所属する文書の種類を示すメタデータは含まない
6. **直線的処理**：復号処理は「シェア ID とパスワード入力 → シェア ID による第 1 段階 MAP 生成 → パスワードによる第 2 段階 MAP 生成（第 1 段階の範囲内で） → シェア選択 → 復号 → 結果返却」と評価や分岐なしに直線的に進行すること
7. **全体更新**：JSON 文書の更新は常に全体置き換えで行い、部分更新は行わない

### 絶対的セキュリティ要件

1. **評価分岐の排除**：復号処理中に「マップが正当か」「復号結果が有効か」などの評価による分岐を一切設けないこと
2. **例外処理なし**：不正なパスワードで生成されたマップでも、そのまま処理を継続し、結果をそのまま返却すること（メモリエラーやタイムアウトなどの外部要因による障害は別の責務とする）
3. **直線的フロー**：シェア ID とパスワード入力 → シェア ID による第 1 段階 MAP 生成 → パスワードによる第 2 段階 MAP 生成（第 1 段階の範囲内で） → シェア選択 → 復号 → 結果返却の流れを厳格に守り、途中にチェックポイントを設けないこと
4. **同一経路処理**：どのようなシェア ID とパスワードの組み合わせに対しても完全に同一の経路を通り、入力されたシェア ID から第 1 段階 MAP を生成し、さらにパスワードから第 2 段階 MAP を生成し、それらのマップに従って復号を試み、その結果を無条件で返却する単純な流れを維持すること
5. **無評価更新**：更新処理においても入力データの評価を行わず、破損した JSON であっても入力されたまま処理すること

### セキュリティ要件

1. **シェア ID 空間配分**：シェア ID 空間は複数の領域に分割（A ユーザー用:30-40%、B ユーザー用:30-40%、未割当領域:20-40%）するが、その配分は連続的な範囲や単純なパターン（偶数/奇数など）ではなく、ID 空間のどの部分を取り出しても A、B、未割当の各割り当てが混在するように分散配置すること
2. **未割当領域の存在**：どのユーザーにも割り当てられない未割当領域をランダムなゴミデータで埋め、攻撃者による統計分析を困難にする
3. **プロセス同一性**：復号処理は文書の種類によって分岐せず、同一のコードパスを通る
4. **ソースコード耐性**：ケルクホフの原理に従い、ソースコードが完全に公開されても、正しいパスワードなしには復号不可能
5. **マップデータ安全性**：パスワードからマップデータへの変換は決定論的であり、同じパスワードからは常に同じマップデータが生成されること
6. **攻撃者モデル**：ソースコードと全アルゴリズムを完全に把握した上で、論理的に解読を試みる攻撃者を想定
7. **全シェア必須方式**：パスワードから生成される MAP が決定論的であるため、指定されたシェアセット全体が復号に必要であり、部分的なシェアセットでは復号不可能であること

### 技術仕様

1. **暗号化対象**：UTF-8 エンコードされた JSON 文書（2 種類まで）
2. **シャミア秘密分散**：適切な閾値とシェア数の設定による秘密分散（閾値個のシェアで復号可能）
3. **シェア ID 割当**：初期化時に全シェア ID 空間の一部を各ユーザーにランダム割当し、残りの未割当領域はランダムなゴミデータで埋める（このゴミデータは元の秘密情報とは完全に分離され、復号には無関係）。割当パターンは、連続範囲や単純な規則性を持たず、ID 空間内のどの部分集合を取り出しても A、B、未割当の識別が統計的に不可能であること
4. **多段 MAP 方式**：シェア ID による可能性範囲の限定後、パスワードから安全な鍵導出関数（KDF）を用いてマップデータを生成
5. **シェア識別**：マップデータを使用して関連するシェアのみを特定・復号（マッピング対象外のシェアは「ゴミ」として無視）
6. **不正パスワード**：不正なパスワードが入力された場合でも評価せず処理を継続し、生成されたマップに基づいて復号を試み、結果をそのまま返却する
7. **無条件処理**：復号処理中に if 文や try-catch などによる条件分岐を暗号化の本質部分では一切排除し、同一経路での処理を保証すること。また、for 文による繰り返し処理においても、「最初に条件に合致したものを採用して処理を中断する」「途中で条件が満たされたら早期リターンする」といった最適化も禁止し、常に全シェアを同一方法で処理し終えることを保証すること（但し、ログ出力や性能計測など暗号化の本質に関わらない部分では許容する）
8. **更新処理**：文書更新時は対象となるシェア ID に限定された範囲内でのみ完全な再暗号化を行い、その範囲内の古いシェアセットのみを完全に破棄すること（他のシェア ID 範囲には影響しない）

### ユーザー体験フロー

1. **シェア ID 生成（初期化）**：システム初期化時にユーザー A と B の両方のシェア ID セットを生成（全体の 60-80%を割当）
2. **データ暗号化**：シェア ID とパスワードを使って秘密情報を分散・暗号化（A のみ、または B のみで実行可能）
3. **データ復号**：ユーザー固有のシェア ID セットとパスワードでマッピングを行い、必要なシェアを選択して復号（他のシェアは「ゴミ」として無視）
4. **データ更新**：ユーザー固有のシェア ID とパスワードを使用して全体を置換（A のみ、または B のみで実行可能）

### 評価指標

以下のサイズの JSON ファイルに対する性能評価を設計書に含めること：

1. 10KB JSON を暗号化した場合の最終ファイルサイズ
2. 100KB JSON を暗号化した場合の最終ファイルサイズ
3. 1MB JSON を暗号化した場合の最終ファイルサイズ

## 設計書で扱うべき技術的課題と考慮点

### シャミア秘密分散法の設計

1. **多項式次数の最適化**：秘密分散における多項式の次数と必要シェア数の関係
2. **閾値設定**：復号に必要なシェア数（閾値）の適切な設定
3. **シェア ID 空間設計**：A ユーザー、B ユーザー、未割当領域の最適な配分方法
4. **シェア同等性**：任意の閾値個のシェアで同等に復号可能なシステムの設計（シャミア秘密分散法の基本機能）

### マップデータ設計

1. **多段 MAP 構成**：シェア ID による可能性限定とパスワードによるマップ生成の 2 段階処理設計
2. **パスワード正規化**：異なる長さのパスワードからの一貫したマップデータ生成
3. **鍵導出関数**：安全な KDF（PBKDF2, Argon2, scrypt など）の選定と設定
4. **マップデータフォーマット**：シェア識別に適した効率的なデータ構造（シェア側には関連性を持たせない設計）
5. **無検証処理**：マップの正当性を検証せずに処理を継続するための設計
6. **更新考慮**：更新時に以前のバージョンとの関連性を持たないシェア生成方法

### セキュリティ設計

1. **区別不可能性**：文書 A 用シェア、文書 B 用シェア、および未割当領域のシェアが統計的・構造的に区別不可能であること
2. **アルゴリズム透明性**：ケルクホフの原理に基づき、マップデータ生成アルゴリズムを含む全システムが完全に公開されても、セキュリティはパスフレーズの強度のみに依存する
3. **パスワード強度**：推奨パスワード強度とエントロピー要件
4. **ソースコード解析耐性**：ソースコードを入手した攻撃者は完全にアルゴリズムを理解できるが、正しいパスワードなしには復号不可能
5. **タイミング攻撃耐性**：条件分岐がないことによるタイミング攻撃への耐性強化
6. **未割当領域の意義**：未割当領域が提供する追加的なセキュリティ特性と攪乱効果

### 実装上の課題

1. **効率的な復号**：多段 MAP 方式を用いた効率的なシェア識別と再構築アルゴリズム（復号に 1 分程度の時間は許容）
2. **シェア ID 割当戦略**：初期化時のシェア ID 空間の効率的かつ安全な割当方法
3. **エラー処理の排除**：エラー発生時でも処理を中断せず、常に何らかの結果を返却する設計（外部要因によるエラーは別の責務として切り分ける）
4. **メモリ効率**：大きな JSON ファイル処理時のメモリ効率は性能に応じて調整可能（2 次的な処理機構に責務を委譲）
5. **条件分岐のない実装**：暗号処理の本質部分では if 文や try-catch などによる条件分岐だけでなく、for 文内での早期リターンや処理スキップも一切使用せず、全シェアを同一方法で処理するアルゴリズムを採用すること。処理時間が一定となるよう、「シェア ID とパスワード入力 → シェア ID による第 1 段階 MAP 生成 → パスワードによる第 2 段階 MAP 生成 → シェア選択 → 復号 → 結果返却」という直線的処理を一定速度で実行すること
6. **更新の原子性**：更新処理においては一時的な作業領域で新シェアセットを完全に生成し、検証した後にのみコミットする方式を採用し、途中で中断された場合は元の状態を維持する方法（データ欠損による永久的な復号不能を防止）
7. **履歴抹消**：更新が完全に成功したことを確認した後にのみ古いシェアを確実に破棄し、過去バージョンへのアクセスを防止する技術（不完全な更新時は古いシェアを保持）

## 生成すべき設計書の内容・構成

1. **詳細設計書**

   - アルゴリズムの詳細説明
   - データフローと処理フロー図（Mermaid 記法を使用すること）
   - シェア構造とマップデータ構造の定義
   - 「シェア ID による可能性限定とパスワードによるマップ生成」という多段 MAP 方式の詳細
   - シェア ID 空間の配分とユーザーへの割当方法
   - データ更新処理のフローと実装方法

2. **セキュリティ分析**

   - 攻撃モデルと脆弱性分析
   - マップデータの安全性証明
   - ソースコード漏洩時のセキュリティ保証
   - 復号処理の完全な同一経路保証の証明
   - 未割当領域がもたらすセキュリティ強化の分析

3. **性能評価**

   - 各サイズの JSON に対する暗号化後ファイルサイズの予測
   - 暗号化/復号処理の計算量と時間複雑性
   - メモリ使用量の評価
   - 更新処理のパフォーマンス評価

4. **実装ガイドライン**

   - 推奨データ構造とアルゴリズム
   - 実績のある暗号ライブラリの活用方法
   - パフォーマンス最適化のためのベストプラクティス
   - 条件分岐を避けるコーディングパターン例
   - シェア ID 空間管理の実装方法

5. **参考資料と出典**
   - 調査に使用した学術論文のリスト
   - 参照したオープンソースプロジェクトへのリンク
   - 技術記事や仕様書の出典
   - 実装例の元となったコードリポジトリ

## 制約条件

設計書を作成する際は、以下の制約条件を遵守すること：

1. サイドチャネル攻撃対策は検討範囲外
2. 復号処理は文書の種類による分岐を含まないこと
3. シェア自体からは所属文書が判別不可能な設計であること
4. 外部データ（ユーザー指定 JSON など）に依存せず、シェア ID とパスワードのみで復号可能であること
5. 将来的に 3 つ以上の文書への対応は不要
6. 復号処理において、マップの正当性や復号結果の有効性を評価する分岐を一切設けないこと
7. 理論的に確かな設計を提供し、推測に基づいた設計は避けること
8. ケルクホフの原理に従い、全アルゴリズムが公開されても安全な設計であること
9. シェア ID 空間には必ず未割当領域（全体の 20-40%）を設けること
