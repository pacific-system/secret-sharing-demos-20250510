# テストランナー現状分析ドキュメント

## 1 メイン処理シーケンス

1. **ログ設定初期化** - setup_logger()でログ環境構築
   - 1.1 **ログディレクトリ作成** - logs/ディレクトリの自動作成
   - 1.2 **ログファイル生成** - test*log*{timestamp}.log ファイル作成
   - 1.3 **ハンドラー設定** - コンソール出力とファイル出力の両方設定
2. **テスト実行開始ログ** - "テスト実行を開始します"メッセージ出力
3. **設定ファイル読み込み** - load_config()実行、失敗時は即座終了
4. **テストケース検出** - discover_test_cases()実行、未発見時は即座終了
   - 4.1 **ディレクトリスキャン** - test_cases/配下の 3 ディレクトリを検索
   - 4.2 **ファイルパターンマッチ** - test\_\*.py ファイルを検索
   - 4.3 **動的モジュールインポート** - importlib.import_module()でロード
   - 4.4 **クラス検査** - BaseTest 継承クラスを検出
   - 4.5 **インスタンス化と ID 検証** - test_id 属性の有効性確認
   - 4.6 **検出結果の一時保存** - test_cases 辞書にテストクラスを保存
5. **分析モジュール検出** - discover_analyzers()実行、未発見でも継続
   - 5.1 **分析ディレクトリスキャン** - analysis/ディレクトリを検索
   - 5.2 **アナライザーファイル検索** - \*\_analyzer.py パターンマッチ
   - 5.3 **アナライザークラス検出** - \*Analyzer で終わるクラス名を検索
   - 5.4 **name 属性検証** - 有効な name 属性を持つかチェック
   - 5.5 **検出結果の一時保存** - analyzers 辞書にアナライザークラスを保存
6. **テスト実行** - run_tests()実行、繰り返し実行対応
   - 6.1 **繰り返し回数設定** - 設定ファイルから読み込み（1-10 回制限）
   - 6.2 **結果保存用データ構造初期化** - all_test_results=[]のみ（latest_test_results 撤廃）
   - 6.3 **イテレーションループ開始** - 指定回数分の繰り返し実行
   - 6.4 **テストケース有効性チェック** - is_test_enabled()で確認
   - 6.5 **テストインスタンス生成** - 各テストクラスのインスタンス化
   - 6.6 **個別テスト実行** - test_instance.run()呼び出し
   - 6.7 **パスワード処理** - test_passwords.txt から読み込み（個別テスト内）
   - 6.8 **CLI 引数ログ出力** - テスト結果の CLI 引数を記録
   - 6.9 **パスワードデバッグログ** - A/B 用パスワードを DEBUG レベルで出力
   - 6.10 **結果記録** - 成功/失敗とエラー情報を構造化記録
   - 6.11 **テスト結果ログ保存** - log_test_result()でログファイルに永続化
   - 6.12 **イテレーション結果の一時保存** - iteration 番号付きで all_test_results に追加
   - 6.13 **メモリ内累積保存** - 全イテレーション結果をメモリ内に保持
   - 6.14 <span style="color: green;">**上書き問題解決** - latest_test_results 撤廃により上書きリスク完全排除</span>
7. **分析実行** - run_analysis()実行、テスト結果を基に分析
   - 7.1 **分析有効性チェック** - is_analysis_enabled()で確認
   - 7.2 **アナライザーインスタンス生成** - 各分析クラスのインスタンス化
   - 7.3 **特別処理判定** - map_intersection には全テスト結果を渡す
   - 7.4 **通常処理** - その他は最新テスト結果のみ
   - 7.5 **分析結果記録** - pass/fail とエラー情報を記録
   - 7.6 **分析結果の一時保存** - analysis_results 辞書に保存
   - 7.7 <span style="color: green;">**動的最新結果取得** - all_test_results[-1]["results"]から安全に最新結果を取得</span>
8. **レポート生成** - generate_report()実行、失敗でも継続
   - 8.1 **レポート生成開始ログ** - "テストレポートを生成しています..."出力
   - 8.2 **タイムスタンプ生成** - YYYYMMDD_HHMMSS 形式
   - 8.3 **ファイル名決定** - test*report*{timestamp}.md
   - 8.4 **全結果データ統合** - 最新結果, analysis_results, all_test_results を統合
   - 8.5 **保護されたデータ** - all_test_results は累積保存で上書きなし
9. **レポート保存** - save_report()実行、失敗でも継続
   - 9.1 **保存成功時** - 保存完了ログ出力
   - 9.2 **保存失敗時** - エラーログ出力（処理継続）
   - 9.3 **レポートファイル永続化** - test*report*{timestamp}.md ファイル作成
   - 9.4 **保護されたデータ** - ログファイルは log_test_result()で永続化済み
10. **テスト完了ログ** - "テスト実行が完了しました"メッセージ出力
11. **結果集計** - 成功数と失敗数をカウント
    - 11.1 <span style="color: green;">**安全な結果集計** - all_test_results[-1]["results"]から最新結果を動的取得</span>
12. **結果サマリーログ** - 合計/成功/失敗数を出力
13. **終了コード決定** - テスト成功/失敗で 0/1 を返却
14. **プロセス終了** - sys.exit()で main()の戻り値を終了コードに設定
